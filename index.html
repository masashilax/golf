
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- iOS Web App settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="V & O golf">
    <meta name="format-detection" content="telephone=no">

    <title>V & O golf</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            background-color: #f3f4f6; 
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            min-height: 100vh;
        }
        input, select, textarea { 
            font-size: 16px !important; 
            box-sizing: border-box !important;
        }
        input[type="number"]::-webkit-inner-spin-button, 
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .btn-press:active { transform: scale(0.96); opacity: 0.9; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .medal-btn { transition: all 0.2s; position: relative; }
        .medal-btn.active { transform: scale(1.1); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .medal-btn.disabled { opacity: 0.15; pointer-events: none; filter: grayscale(100%); }

        .opt-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(65px, 1fr)); 
            gap: 6px;
            margin-top: 8px;
        }
        
        .opt-btn { 
            font-size: 0.65rem; 
            padding: 6px 2px; 
            border-radius: 6px; 
            border: 1px solid #e5e7eb; 
            background: white; 
            color: #6b7280; 
            transition: all 0.2s;
            white-space: nowrap;
            text-align: center;
            font-weight: 500;
        }
        
        .opt-btn.active { background: #eff6ff; border-color: #3b82f6; color: #2563eb; font-weight: bold; }
        .opt-btn.active-red { background: #fef2f2; border-color: #ef4444; color: #dc2626; font-weight: bold; }
        .opt-btn.active-gold { background: #fefce8; border-color: #eab308; color: #a16207; font-weight: bold; }
        
        .opt-btn.placeholder {
            border-style: dashed;
            background: transparent;
            color: #d1d5db;
            opacity: 0.6;
        }

        .opt-btn.achieved { 
            background: linear-gradient(135deg, #fef9c3 0%, #facc15 100%); 
            border-color: #eab308; 
            color: #713f12; 
            font-weight: 900; 
            box-shadow: 0 2px 4px rgba(234, 179, 8, 0.4);
            transform: scale(1.05);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0.4); }
            70% { box-shadow: 0 0 0 6px rgba(234, 179, 8, 0); }
            100% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0); }
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #d1d5db;
            transition: .4s;
            border-radius: 24px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 18px; width: 18px;
            left: 3px; bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: #16a34a; }
        input:checked + .slider:before { transform: translateX(20px); }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .animate-fade-in { animation: fadeIn 0.2s ease-out forwards; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const generateId = () => Math.random().toString(36).substr(2, 9);
        const getToday = () => new Date().toISOString().split('T')[0];

        const calcOlympicRelative = (pId, allPointsMap) => {
            const pIds = Object.keys(allPointsMap);
            if (pIds.length === 0) return 0;
            const myPoint = allPointsMap[pId] || 0;
            const totalSum = pIds.reduce((sum, id) => sum + (allPointsMap[id] || 0), 0);
            return (myPoint * pIds.length) - totalSum;
        };

        const App = () => {
            const [view, setView] = useState('HOME');
            const [games, setGames] = useState([]);
            const [activeGameId, setActiveGameId] = useState(null);
            const [showExitConfirm, setShowExitConfirm] = useState(false);
            const [showRules, setShowRules] = useState(false);

            const [setupInfo, setSetupInfo] = useState({
                course: '',
                date: getToday(),
                startSide: 'OUT',
                playerData: [
                    { name: 'æ¾æœ¬æ´‹ä»‹', order: 1 },
                    { name: '', order: 2 },
                    { name: '', order: 3 },
                    { name: '', order: 4 }
                ],
                settings: { vegas: true, olympic: true, vegasLogic: 'basic' }
            });

            const navigateTo = (nextView) => {
                setView(nextView);
                window.scrollTo({ top: 0, behavior: 'instant' });
            };

            useEffect(() => {
                const saved = localStorage.getItem('golf_vegas_data');
                if (saved) setGames(JSON.parse(saved));
            }, []);

            useEffect(() => {
                localStorage.setItem('golf_vegas_data', JSON.stringify(games));
            }, [games]);

            const createGame = (finalSetup) => {
                const newGame = {
                    id: generateId(),
                    date: finalSetup.date,
                    course: finalSetup.course,
                    players: finalSetup.players,
                    scores: [],
                    currentHole: finalSetup.startHole || 1,
                    currentOrder: finalSetup.currentOrder,
                    totalVegasPoints: finalSetup.players.reduce((a,p)=>({...a,[p.id]:0}),{}),
                    totalOlympicPoints: finalSetup.players.reduce((a,p)=>({...a,[p.id]:0}),{}),
                    settings: finalSetup.settings,
                    vegasMultiplier: 1,
                    isFinished: false
                };
                setGames(prev => [newGame, ...prev]);
                setActiveGameId(newGame.id);
                navigateTo('GAME');
            };

            const updateGame = (updatedGame) => {
                setGames(prev => prev.map(g => g.id === updatedGame.id ? updatedGame : g));
            };

            const deleteGame = (id) => {
                setGames(prev => prev.filter(g => g.id !== id));
            };

            const activeGame = games.find(g => g.id === activeGameId);

            return (
                <div className="max-w-md mx-auto min-h-screen bg-gray-100 flex flex-col relative">
                    <div className="bg-green-700 text-white p-4 pt-4 shadow-lg sticky top-0 z-50 flex justify-between items-center border-b border-green-800">
                        <h1 className="text-lg font-bold flex items-center gap-2 truncate mr-2 italic pr-2">
                            <i className="fa-solid fa-golf-ball-tee"></i> V & O golf
                        </h1>
                        <div className="flex gap-2 items-center flex-shrink-0">
                            <button onClick={() => setShowRules(true)} className="text-xs bg-green-600/50 px-3 py-2 rounded-lg font-bold shadow-sm active:bg-green-800 text-white border border-green-500/30">
                                <i className="fa-solid fa-circle-info"></i>
                            </button>
                            {view !== 'HOME' && (
                                <button 
                                    onClick={() => setShowExitConfirm(true)} 
                                    className="text-xs bg-red-600 px-3 py-2 rounded-lg font-bold shadow-sm active:bg-red-700 text-white border border-red-500"
                                >
                                    çµ‚äº†
                                </button>
                            )}
                            <button onClick={() => window.location.reload()} className="text-xs bg-green-800 px-3 py-2 rounded-lg font-bold shadow-sm active:bg-green-900 text-white border border-green-600/50">
                                <i className="fa-solid fa-rotate-right"></i>
                            </button>
                        </div>
                    </div>

                    <div className="flex-1 p-4 pb-24 safe-area-bottom">
                        {view === 'HOME' && (
                            <HomeScreen 
                                games={games} 
                                onNew={() => navigateTo('NEW')} 
                                onSelect={(id) => { setActiveGameId(id); navigateTo('GAME'); }} 
                                onDelete={(id) => deleteGame(id)} 
                            />
                        )}
                        {view === 'NEW' && (
                            <NewGameScreen 
                                setupInfo={setupInfo}
                                setSetupInfo={setSetupInfo}
                                onCancel={() => navigateTo('HOME')} 
                                onCreate={createGame} 
                            />
                        )}
                        {view === 'GAME' && activeGame && (
                            <GameScreen 
                                game={activeGame} 
                                onUpdate={updateGame} 
                                onBack={() => navigateTo('HOME')} 
                                onRestartSetup={() => {
                                    deleteGame(activeGame.id);
                                    navigateTo('NEW');
                                }}
                            />
                        )}
                    </div>

                    {showExitConfirm && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-[200] animate-fade-in backdrop-blur-sm">
                            <div className="bg-white rounded-3xl w-full max-w-sm p-6 text-center shadow-2xl">
                                <div className="w-16 h-16 bg-red-50 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <i className="fa-solid fa-door-open text-red-500 text-3xl"></i>
                                </div>
                                <h3 className="text-gray-800 text-lg font-black mb-2">çµ‚äº†ç¢ºèª</h3>
                                <p className="text-gray-500 text-sm mb-6 leading-relaxed">ç·¨é›†ã‚’çµ‚äº†ã—ã¦<br/>ãƒ›ãƒ¼ãƒ ç”»é¢ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ</p>
                                <div className="flex gap-3">
                                    <button onClick={() => setShowExitConfirm(false)} className="flex-1 py-3.5 bg-gray-100 text-gray-500 rounded-xl font-bold btn-press">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                                    <button onClick={() => { setShowExitConfirm(false); navigateTo('HOME'); }} className="flex-1 py-3.5 bg-red-600 text-white rounded-xl font-bold shadow-lg btn-press">çµ‚äº†ã™ã‚‹</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showRules && <RulesModal onClose={() => setShowRules(false)} />}
                </div>
            );
        };

        const RulesModal = ({ onClose }) => (
            <div className="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-[300] backdrop-blur-sm animate-fade-in">
                <div className="bg-white rounded-3xl w-full max-w-sm p-6 shadow-2xl relative overflow-hidden max-h-[90vh] flex flex-col">
                    <div className="absolute top-0 left-0 w-full h-2 bg-green-600"></div>
                    <h3 className="text-gray-800 text-xl font-black mb-4 text-center">ãƒ«ãƒ¼ãƒ«ä¸€è¦§</h3>
                    <div className="flex-1 overflow-y-auto no-scrollbar space-y-6 text-xs text-gray-600 leading-relaxed">
                        <section>
                            <h4 className="font-bold text-blue-600 border-b border-blue-100 pb-1 mb-2">ãƒ©ã‚¹ãƒ™ã‚¬ã‚¹ (Vegas)</h4>
                            <ul className="list-disc pl-4 space-y-1">
                                <li><strong>ãƒãƒ¼ãƒ åˆ†ã‘:</strong> åŸºæœ¬ã¯æ‰“é †1&4 vs 2&3 (3äººæ™‚ã¯1&3 vs 2ä½Ã—2)ã€€ã‚ªãƒªã‚¸ãƒŠãƒ«è¨­å®šæ™‚ã¯æ¯ã‚³ãƒ¼ã‚¹æ‰‹å‹•ã§æŒ‡å®š</li>
                                <li><strong>ç‚¹æ•°ç®—å‡º:</strong> ãƒãƒ¼ãƒ 2äººã®ã‚¹ã‚³ã‚¢ã‚’å°â†’å¤§ã®é †ã«ä¸¦ã¹ãŸ2æ¡åŒå£«ã®å·®ã§æ¯”è¼ƒã—ã€5ç‚¹å˜ä½åˆ‡ã‚Šä¸Šã’</li>
                                <li><strong>å…¥ã‚Œæ›¿ãˆ:</strong> ç›¸æ‰‹ãŒãƒãƒ¼ãƒ‡ã‚£ä»¥ä¸Šã§è‡ªåˆ†ã®æ•°å­—ãŒå¤§â†’å°ã¸</li>
                                <li><strong>æ”¹å–„:</strong> ç›¸æ‰‹ãŒã‚¤ãƒ¼ã‚°ãƒ«ä»¥ä¸Šã§è‡ªåˆ†ã®æ•°å­—ãŒå°â†’å°(ã‚¾ãƒ­ç›®)ã¸</li>
                                <li><strong>å€ç‡:</strong> ã‚¤ãƒ¼ã‚°ãƒ«ç²å¾—ã€ã¾ãŸã¯ãƒãƒ¼ãƒ 2äººãƒãƒ¼ãƒ‡ã‚£ã§2å€</li>
                                <li><strong>ã‚­ãƒ£ãƒªãƒ¼:</strong> åŒç‚¹æ™‚ã¯æ¬¡ãƒ›ãƒ¼ãƒ«å€ç‡+1ã§æŒã¡è¶Šã—</li>
                            </ul>
                        </section>
                        <section>
                            <h4 className="font-bold text-yellow-600 border-b border-yellow-100 pb-1 mb-2">ã‚ªãƒªãƒ³ãƒ”ãƒƒã‚¯ (Olympic)</h4>
                            <ul className="list-disc pl-4 space-y-1">
                                <li><strong>ãƒ¡ãƒ€ãƒ«:</strong> ğŸ’5ç‚¹ã€ğŸ¥‡4ç‚¹ã€ğŸ¥ˆ3ç‚¹ã€ğŸ¥‰2ç‚¹ã€ğŸ”©1ç‚¹</li>
                                <li><strong>åˆ¶é™:</strong> 3äººæ™‚ã¯ğŸ”©ãªã—</li>
                                <li><strong>ã‚¤ãƒ¼ã‚°ãƒ«ç‚¹:</strong> ã‚¤ãƒ¼ã‚°ãƒ«ã§15ç‚¹</li>
                                <li><strong>ãƒãƒ¼ãƒ‡ã‚£ç‚¹:</strong> ãƒãƒ¼ãƒ‡ã‚£ã§3ç‚¹</li>
                                <li><strong>ç«¿ã„ã¡:</strong> ç«¿å®£è¨€æˆåŠŸã§3ç‚¹ã€å¤±æ•—ã§-3ç‚¹</li>
                                <li><strong>ç ‚ã„ã¡:</strong> ãƒãƒ³ã‚«ãƒ¼â†’ãƒ¯ãƒ³ãƒ‘ãƒƒãƒˆæˆåŠŸã§3ç‚¹</li>
                               <li><strong>ãƒ‹ã‚¢ãƒ”ãƒ³:</strong> Par3ãƒ¯ãƒ³ã‚ªãƒ³æˆåŠŸã§3ç‚¹ã€ãŸã ã—ï¼“ãƒ‘ãƒƒãƒˆãªã‚‰ç„¡åŠ¹</li>
                                <li><strong>é€†ã‚ªãƒª:</strong> ğŸ’-5ç‚¹ã€ğŸ¥‡-4ç‚¹ã€ğŸ¥ˆ-3ç‚¹ã€ğŸ¥‰-2ç‚¹ã€ğŸ”©-1ç‚¹</li>
                                <li><strong>4ã‚«ãƒ¼ãƒ‰:</strong> åŒè‰²4æšã§ãƒ¡ãƒ€ãƒ«ç‚¹Ã—4å€ã€‚</li>
                                <li><strong>ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆ:</strong> é‡‘éŠ€éŠ…é‰„ã®4ç¨®ã§10ç‚¹(ğŸ’è¾¼ãªã‚‰15ç‚¹)ã€‚</li>
                                <li><strong>æœ€çµ‚ç®—å‡º:</strong> (æŒç‚¹Ã—äººæ•°) - å…¨å“¡åˆè¨ˆç‚¹ã€‚</li>
                            </ul>
                        </section>
                       
                    </div>
                    <button onClick={onClose} className="w-full mt-6 py-4 bg-green-600 text-white rounded-2xl font-bold shadow-md btn-press">é–‰ã˜ã‚‹</button>
                </div>
            </div>
        );

        const HomeScreen = ({ games, onNew, onSelect, onDelete }) => {
            const [deleteTarget, setDeleteTarget] = useState(null);
            return (
                <div className="space-y-6">
                    <div>
                        <h2 className="text-gray-500 text-xs font-bold mb-3 uppercase tracking-wider ml-1">å±¥æ­´ ({games.length})</h2>
                        {games.length === 0 && <p className="text-center text-gray-400 py-12 bg-white rounded-xl border border-dashed border-gray-300">å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>}
                        <div className="space-y-3">
                            {games.map(game => {
                                const totalPar = game.scores.reduce((sum, h) => sum + h.par, 0);
                                return (
                                    <div key={game.id} onClick={() => onSelect(game.id)} className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 active:bg-gray-50 transition cursor-pointer relative overflow-hidden btn-press">
                                        <div className="absolute top-0 left-0 w-1.5 h-full bg-green-500"></div>
                                        <div className="flex justify-between items-start pl-3 mb-2">
                                            <div>
                                                <h3 className="font-bold text-gray-800 text-lg leading-tight">
                                                    {game.course || 'ã‚³ãƒ¼ã‚¹æœªè¨­å®š'}
                                                    {totalPar > 0 && <span className="ml-2 text-xs text-gray-400 font-normal italic">Par {totalPar}</span>}
                                                </h3>
                                                <p className="text-gray-400 text-xs mt-1 font-medium"><i className="far fa-calendar-alt mr-1"></i>{game.date}</p>
                                            </div>
                                            <button onClick={(e) => {
                                                e.stopPropagation();
                                                setDeleteTarget(game.id);
                                            }} className="text-gray-300 hover:text-red-500 p-2 -mr-2 -mt-2">
                                                <i className="fa-solid fa-trash"></i>
                                            </button>
                                        </div>
                                        <div className="pl-3 grid grid-cols-2 gap-x-2 gap-y-2">
                                            {game.players.map((p, i) => {
                                                const vP = game.totalVegasPoints ? game.totalVegasPoints[p.id] : 0;
                                                const relOP = calcOlympicRelative(p.id, game.totalOlympicPoints || {});
                                                const totalStrokes = game.scores.reduce((sum, h) => sum + (parseInt(h.scores[p.id]) || 0), 0);
                                                const diff = totalStrokes - totalPar;
                                                const diffText = diff === 0 ? 'E' : (diff > 0 ? '+' + diff : diff);
                                                const diffColorClass = diff === 0 ? 'text-black' : (diff > 0 ? 'text-red-500' : 'text-blue-600');
                                                return (
                                                    <div key={i} className="text-[10px] text-gray-500 border-b border-gray-50 pb-1 flex flex-col">
                                                        <span className="font-bold text-gray-700 truncate mb-0.5">{p.name}</span>
                                                        <div className="flex flex-wrap gap-x-2">
                                                            {game.settings?.vegas && (
                                                                <span className="whitespace-nowrap"><span className="font-bold text-gray-900">V:</span> <span className={vP >= 0 ? (vP === 0 ? 'text-gray-500' : 'text-blue-600 font-bold') : 'text-red-500 font-bold'}>{vP > 0 ? '+' : ''}{vP}</span></span>
                                                            )}
                                                            {game.settings?.olympic && (
                                                                <span className="whitespace-nowrap"><span className="font-bold text-gray-900">O:</span> <span className={relOP >= 0 ? (relOP === 0 ? 'text-gray-500' : 'text-blue-600 font-bold') : 'text-red-500 font-bold'}>{relOP > 0 ? '+' : ''}{relOP}</span></span>
                                                            )}
                                                            <span className="whitespace-nowrap"><span className="font-bold text-gray-900">T:</span> <span className="text-gray-800 font-bold">{totalStrokes || '-'}</span> {totalStrokes > 0 && <span className={`ml-0.5 font-bold ${diffColorClass}`}>({diffText})</span>}</span>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                    {deleteTarget && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-[210] animate-fade-in backdrop-blur-sm">
                            <div className="bg-white rounded-3xl w-full max-sm p-6 text-center shadow-2xl">
                                <div className="w-16 h-16 bg-red-50 rounded-full flex items-center justify-center mx-auto mb-4"><i className="fa-solid fa-trash-can text-red-500 text-3xl"></i></div>
                                <h3 className="text-gray-800 text-lg font-black mb-2">å±¥æ­´ã®å‰Šé™¤</h3>
                                <p className="text-gray-500 text-sm mb-6">å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ</p>
                                <div className="flex gap-3">
                                    <button onClick={() => setDeleteTarget(null)} className="flex-1 py-3.5 bg-gray-100 text-gray-500 rounded-xl font-bold btn-press">æˆ»ã‚‹</button>
                                    <button onClick={() => { onDelete(deleteTarget); setDeleteTarget(null); }} className="flex-1 py-3.5 bg-red-600 text-white rounded-xl font-bold shadow-lg btn-press">å‰Šé™¤</button>
                                </div>
                            </div>
                        </div>
                    )}
                    <button onClick={onNew} className="fixed bottom-10 right-6 md:right-[calc(50%-180px)] w-16 h-16 bg-green-600 hover:bg-green-700 text-white rounded-full shadow-2xl flex items-center justify-center text-3xl btn-press z-50"><i className="fa-solid fa-plus"></i></button>
                </div>
            );
        };

        const NewGameScreen = ({ setupInfo, setSetupInfo, onCancel, onCreate }) => {
            const handleSubmit = () => {
                if (!setupInfo.course) { alert('ã‚´ãƒ«ãƒ•å ´åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
                const activePlayersData = setupInfo.playerData.filter(p => p.name.trim() !== '');
                if (activePlayersData.length < 3) { alert('æœ€ä½3åã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

                const players = activePlayersData.map((p, i) => ({ id: String(i), name: p.name }));
                const initialIds = players.map(p => p.id);
                const currentOrder = initialIds.sort((a, b) => {
                    return activePlayersData[parseInt(a)].order - activePlayersData[parseInt(b)].order;
                });

                onCreate({ 
                    date: setupInfo.date, 
                    course: setupInfo.course, 
                    players, 
                    settings: setupInfo.settings, 
                    currentOrder, 
                    startHole: setupInfo.startSide === 'OUT' ? 1 : 10 
                });
            };

            const updatePlayer = (idx, field, val) => {
                const newData = [...setupInfo.playerData];
                newData[idx][field] = val;
                setSetupInfo({...setupInfo, playerData: newData});
            };

            const resetPlayers = () => setSetupInfo({
                ...setupInfo,
                playerData: [
                    { name: 'æ¾æœ¬æ´‹ä»‹', order: 1 }, { name: '', order: 2 }, { name: '', order: 3 }, { name: '', order: 4 }
                ]
            });

            return (
                <div className="bg-white rounded-2xl shadow-sm p-5 space-y-6">
                    <h2 className="text-lg font-bold text-center border-b pb-3 text-gray-700">æ–°è¦ã‚²ãƒ¼ãƒ è¨­å®š</h2>
                    <div className="space-y-4">
                        <div className="w-full overflow-hidden">
                            <label className="block text-xs font-bold text-gray-500 mb-1 uppercase">æ—¥ä»˜</label>
                            <input 
                                type="date" 
                                value={setupInfo.date} 
                                onChange={(e) => setSetupInfo({...setupInfo, date: e.target.value})} 
                                className="w-full block box-border p-3 bg-gray-50 rounded-xl font-bold text-gray-800 outline-none h-12 max-w-full appearance-none" 
                            />
                        </div>
                        <div>
                            <label className="block text-xs font-bold text-gray-500 mb-1 uppercase">ã‚´ãƒ«ãƒ•å ´å</label>
                            <input 
                                type="text" 
                                value={setupInfo.course} 
                                onChange={(e) => setSetupInfo({...setupInfo, course: e.target.value})} 
                                className="w-full block box-border p-3 bg-gray-50 rounded-xl font-bold text-gray-800 h-12" 
                            />
                        </div>
                        <div>
                            <label className="block text-xs font-bold text-gray-500 mb-1 uppercase">ãƒ¢ãƒ¼ãƒ‰</label>
                            <div className="bg-gray-50 p-4 rounded-xl space-y-3">
                                <div className="flex justify-between items-center">
                                    <span className="text-sm font-bold text-gray-700">ãƒ©ã‚¹ãƒ™ã‚¬ã‚¹ (ãƒãƒ¼ãƒ æˆ¦)</span>
                                    <label className="switch"><input type="checkbox" checked={setupInfo.settings.vegas} onChange={() => setSetupInfo({...setupInfo, settings: {...setupInfo.settings, vegas: !setupInfo.settings.vegas}})} /><span className="slider"></span></label>
                                </div>
                                {setupInfo.settings.vegas && (
                                    <div className="pl-4 py-2 border-l-2 border-blue-200 animate-fade-in">
                                        <label className="block text-[10px] font-bold text-gray-400 uppercase mb-2">ãƒãƒ¼ãƒ åˆ†ã‘ãƒ«ãƒ¼ãƒ«</label>
                                        <div className="flex bg-white rounded-lg p-1 border">
                                            <button 
                                                onClick={() => setSetupInfo({...setupInfo, settings: {...setupInfo.settings, vegasLogic: 'basic'}})}
                                                className={`flex-1 py-1.5 rounded-md text-[10px] font-bold transition ${setupInfo.settings.vegasLogic === 'basic' ? 'bg-blue-600 text-white shadow' : 'text-gray-400'}`}
                                            >åŸºæœ¬(14vs23)</button>
                                            <button 
                                                onClick={() => setSetupInfo({...setupInfo, settings: {...setupInfo.settings, vegasLogic: 'original'}})}
                                                className={`flex-1 py-1.5 rounded-md text-[10px] font-bold transition ${setupInfo.settings.vegasLogic === 'original' ? 'bg-blue-600 text-white shadow' : 'text-gray-400'}`}
                                            >ã‚ªãƒªã‚¸ãƒŠãƒ«(æ‰‹å‹•)</button>
                                        </div>
                                    </div>
                                )}
                                <div className="flex justify-between items-center"><span className="text-sm font-bold text-gray-700">ã‚ªãƒªãƒ³ãƒ”ãƒƒã‚¯ (ãƒ‘ã‚¿ãƒ¼æˆ¦)</span><label className="switch"><input type="checkbox" checked={setupInfo.settings.olympic} onChange={() => setSetupInfo({...setupInfo, settings: {...setupInfo.settings, olympic: !setupInfo.settings.olympic}})} /><span className="slider"></span></label></div>
                            </div>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={() => setSetupInfo({...setupInfo, startSide: 'OUT'})} className={`flex-1 py-3 rounded-xl font-bold ${setupInfo.startSide === 'OUT' ? 'bg-green-600 text-white shadow' : 'bg-gray-100 text-gray-400'}`}>OUT</button>
                            <button onClick={() => setSetupInfo({...setupInfo, startSide: 'IN'})} className={`flex-1 py-3 rounded-xl font-bold ${setupInfo.startSide === 'IN' ? 'bg-green-600 text-white shadow' : 'bg-gray-100 text-gray-400'}`}>IN</button>
                        </div>
                        <div className="space-y-4">
                            <div className="flex justify-between items-end mb-1">
                                <label className="block text-xs font-bold text-gray-500 uppercase">ãƒ¡ãƒ³ãƒãƒ¼ã¨åˆæœŸæ‰“é †ï¼ˆ3åä»¥ä¸Šï¼‰</label>
                                <button onClick={resetPlayers} className="text-[10px] text-green-600 font-bold bg-green-50 px-2 py-1 rounded">ã‚¯ãƒªã‚¢</button>
                            </div>
                            {setupInfo.playerData.map((p, i) => (
                                <div key={i} className="flex gap-2">
                                    <input type="text" value={p.name} onChange={(e) => updatePlayer(i, 'name', e.target.value)} placeholder={`ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${i+1}`} className="flex-1 p-2.5 bg-gray-50 rounded-lg text-sm h-11" />
                                    <select value={p.order} onChange={(e) => updatePlayer(i, 'order', parseInt(e.target.value))} className="w-20 p-2.5 bg-gray-100 rounded-lg text-xs font-bold h-11">
                                        {[1, 2, 3, 4].map(n => <option key={n} value={n}>{n}ç•ªç›®</option>)}
                                    </select>
                                </div>
                            ))}
                        </div>
                    </div>
                    <div className="flex gap-3 pt-2">
                        <button onClick={onCancel} className="flex-1 py-3 bg-gray-100 text-gray-600 rounded-xl font-bold btn-press">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                        <button onClick={handleSubmit} className="flex-1 py-3 bg-green-600 text-white rounded-xl font-bold shadow-md btn-press">é–‹å§‹</button>
                    </div>
                </div>
            );
        };

        const GameScreen = ({ game, onUpdate, onBack, onRestartSetup }) => {
            const [par, setPar] = useState(4);
            const [scores, setScores] = useState(game.players.reduce((a,p)=>({...a,[p.id]:''}),{}));
            const [showFinal, setShowFinal] = useState(false);
            const [showOlympic, setShowOlympic] = useState(game.settings.olympic || !game.settings.vegas);
            const [olympicMedals, setOlympicMedals] = useState({}); 
            const [undoConfirm, setUndoConfirm] = useState(false); 
            const [setupConfirm, setSetupConfirm] = useState(false);

            const isThree = game.players.length === 3;
            const [manualTeamA, setManualTeamA] = useState([]);

            const initialOpts = {
                rodState: 0, sand: false, near: false, reverse: false, 
                birdie: false, eagle: false, four: false, straight: false, manualAdj: ''
            };
            const [playerOptions, setPlayerOptions] = useState(game.players.reduce((a,p)=>({...a,[p.id]:{...initialOpts}}),{}));

            const MEDAL_PTS = { diamond: 5, gold: 4, silver: 3, bronze: 2, iron: 1 };
            const MEDAL_REVERSE_PTS = { diamond: -5, gold: -1, silver: -2, bronze: -3, iron: -4 };

            const getPlayerMedalStats = (pId, currentMedal) => {
                let counts = { diamond: 0, gold: 0, silver: 0, bronze: 0, iron: 0 };
                game.scores.forEach(h => { if (h.medals && h.medals[pId]) counts[h.medals[pId]]++; });
                if (currentMedal) counts[currentMedal]++;
                return counts;
            };

            const calcStraightSets = (counts) => {
                let sets = 0, c = { ...counts };
                while (true) {
                    let needed = ['gold', 'silver', 'bronze', 'iron'], missing = 0;
                    needed.forEach(m => { if (!c[m] || c[m] <= 0) missing++; });
                    if (missing === 0) { needed.forEach(m => c[m]--); sets++; }
                    else if (c['diamond'] >= missing) {
                        needed.forEach(m => { if (c[m] > 0) c[m]--; });
                        c['diamond'] -= missing; sets++;
                    } else break;
                }
                return sets;
            };

            useEffect(() => {
                if (game.settings.vegasLogic === 'original') {
                    const defaultA = isThree ? [game.currentOrder[0], game.currentOrder[2]] : [game.currentOrder[0], game.currentOrder[3]];
                    setManualTeamA(defaultA);
                }
            }, [game.currentHole, game.settings.vegasLogic]);

            useEffect(() => {
                setPlayerOptions(prev => {
                    const next = { ...prev };
                    game.players.forEach(p => {
                        const currentMedal = olympicMedals[p.id];
                        const counts = getPlayerMedalStats(p.id, currentMedal);
                        const prevCounts = getPlayerMedalStats(p.id, null); 
                        let isFourCard = false;
                        ['diamond', 'gold', 'silver', 'bronze', 'iron'].forEach(type => {
                            if (counts[type] > 0 && counts[type] % 4 === 0 && counts[type] !== prevCounts[type]) isFourCard = true;
                        });
                        const isStraight = calcStraightSets(counts) > calcStraightSets(prevCounts);
                        const sVal = parseInt(scores[p.id]);
                        next[p.id] = { 
                            ...prev[p.id], 
                            four: isFourCard, 
                            straight: isStraight,
                            birdie: !isNaN(sVal) ? sVal === par - 1 : prev[p.id].birdie,
                            eagle: !isNaN(sVal) ? sVal <= par - 2 : prev[p.id].eagle
                        };
                    });
                    return next;
                });
            }, [olympicMedals, scores, par]);

            const takenMedals = useMemo(() => {
                return Object.entries(olympicMedals).reduce((acc, [id, type]) => { acc[type] = id; return acc; }, {});
            }, [olympicMedals]);

            const toggleManualTeam = (pid) => {
                setManualTeamA(prev => {
                    if (prev.includes(pid)) {
                        return prev.filter(id => id !== pid);
                    } else {
                        if (prev.length < 2) return [...prev, pid];
                        return prev;
                    }
                });
            };

            const handleCalculateAndSave = () => {
                for(let p of game.players) { if(scores[p.id] === '') { alert('å…¨å“¡ã®ã‚¹ã‚³ã‚¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; } }
                
                let team1, team2;
                if (game.settings.vegasLogic === 'original') {
                    if (isThree) {
                        if (manualTeamA.length !== 2) { alert('å…ˆè¡Œãƒãƒ¼ãƒ ã‚’2åé¸æŠã—ã¦ãã ã•ã„ï¼ˆæ®‹ã‚Šã®1åãŒ2å€ã¨ãªã‚Šã¾ã™ï¼‰'); return; }
                        team1 = manualTeamA;
                        const singletonId = game.players.find(p => !manualTeamA.includes(p.id)).id;
                        team2 = [singletonId, singletonId];
                    } else {
                        if (manualTeamA.length !== 2) { alert('å…ˆè¡Œãƒãƒ¼ãƒ ã‚’2åé¸æŠã—ã¦ãã ã•ã„'); return; }
                        team1 = manualTeamA;
                        team2 = game.players.filter(p => !manualTeamA.includes(p.id)).map(p => p.id);
                    }
                } else {
                    if (isThree) {
                        team1 = [game.currentOrder[0], game.currentOrder[2]];
                        team2 = [game.currentOrder[1], game.currentOrder[1]];
                    } else {
                        team1 = [game.currentOrder[0], game.currentOrder[3]];
                        team2 = [game.currentOrder[1], game.currentOrder[2]];
                    }
                }

                const s = (pid) => parseInt(scores[pid]);
                let vegasDiff = 0, olympicPoints = game.players.reduce((a,p)=>({...a,[p.id]:0}),{});
                const currentMultiplier = game.vegasMultiplier || 1;
                
                if (game.settings.vegas) {
                    const t1S = team1.map(pid => s(pid)), t2S = team2.map(pid => s(pid));
                    let p1 = Math.min(...t1S) * 10 + Math.max(...t1S), p2 = Math.min(...t2S) * 10 + Math.max(...t2S);
                    const checkV = (scs) => {
                        const hasE = scs.some(sc => sc <= par - 2), bCount = scs.filter(sc => sc <= par - 1).length;
                        return { rank: (hasE || bCount === 2) ? 2 : (bCount > 0 ? 1 : 0) };
                    };
                    const res1 = checkV(t1S), res2 = checkV(t2S);
                    let mult = 1;
                    if (res1.rank > 0) { if (res1.rank === 2) mult *= 2; p2 = Math.max(...t2S) * 10 + Math.min(...t2S); }
                    if (res2.rank > 0) { if (res2.rank === 2) mult *= 2; p1 = Math.min(...t1S) * 10 + Math.min(...t1S); }
                    const raw = (p2 - p1) * mult;
                    vegasDiff = (raw >= 0 ? Math.ceil(Math.abs(raw) / 5) * 5 : -Math.ceil(Math.abs(raw) / 5) * 5) * currentMultiplier;
                }

                if (game.settings.olympic) {
                    game.players.forEach(p => {
                        const opt = playerOptions[p.id], medal = olympicMedals[p.id];
                        let pts = 0;
                        if (opt.eagle) pts += 15; else if (opt.birdie) pts += 3;
                        if (opt.sand) pts += 3; if (opt.rodState === 1) pts += 3; else if (opt.rodState === -1) pts -= 3;
                        if (medal) pts += (opt.reverse ? MEDAL_REVERSE_PTS[medal] : MEDAL_PTS[medal]);
                        if (par === 3 && opt.near && !opt.reverse) pts += 3;
                        if (opt.four) {
                            const c = getPlayerMedalStats(p.id, medal);
                            ['diamond','gold','silver','bronze','iron'].forEach(t => { if(c[t]>0 && c[t]%4===0) pts += (MEDAL_PTS[t]*4); });
                        }
                        if (opt.straight) pts += (getPlayerMedalStats(p.id, medal).diamond > 0 ? 15 : 10);
                        pts += (parseInt(opt.manualAdj) || 0);
                        olympicPoints[p.id] = pts;
                    });
                }

                const newHistory = [...game.scores, { 
                    hole: game.currentHole, par, vegasDiff, olympicPoints, scores: { ...scores }, 
                    teams: { t1: team1, t2: Array.from(new Set(team2)) }, medals: { ...olympicMedals }, orderBefore: [...game.currentOrder],
                    multiplierUsed: currentMultiplier, achievements: game.players.reduce((a,p)=>({...a,[p.id]:{four:playerOptions[p.id].four,straight:playerOptions[p.id].straight}}),{})
                }];
                
                const newVegasTotal = { ...game.totalVegasPoints }, newOlympicTotal = { ...game.totalOlympicPoints };
                game.players.forEach(p => {
                    if (isThree) {
                        if (team1.includes(p.id)) newVegasTotal[p.id] += vegasDiff;
                        else newVegasTotal[p.id] += (-vegasDiff * 2);
                    } else {
                        newVegasTotal[p.id] += (team1.includes(p.id) ? vegasDiff : -vegasDiff);
                    }
                    newOlympicTotal[p.id] += olympicPoints[p.id];
                });

                onUpdate({ 
                    ...game, 
                    currentHole: game.currentHole === 18 ? 1 : game.currentHole + 1, 
                    currentOrder: [...game.currentOrder].sort((a,b) => s(a)-s(b) || game.currentOrder.indexOf(a)-game.currentOrder.indexOf(b)), 
                    totalVegasPoints: newVegasTotal, totalOlympicPoints: newOlympicTotal, 
                    vegasMultiplier: (game.settings.vegas && vegasDiff === 0) ? currentMultiplier + 1 : 1,
                    scores: newHistory 
                });
                setScores(game.players.reduce((a,p)=>({...a,[p.id]:''}),{})); setOlympicMedals({}); setPar(4);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            const handleUndoLastHole = () => {
                const last = [...game.scores].pop(); 
                const newVegasTotal = { ...game.totalVegasPoints }, newOlympicTotal = { ...game.totalOlympicPoints };
                
                game.players.forEach(p => {
                    if (isThree) {
                        if (last.teams.t1.includes(p.id)) newVegasTotal[p.id] -= last.vegasDiff;
                        else newVegasTotal[p.id] -= (-last.vegasDiff * 2);
                    } else {
                        newVegasTotal[p.id] -= (last.teams.t1.includes(p.id) ? last.vegasDiff : -last.vegasDiff);
                    }
                    newOlympicTotal[p.id] -= (last.olympicPoints[p.id] || 0);
                });
                onUpdate({ 
                    ...game, currentHole: last.hole, currentOrder: last.orderBefore, 
                    totalVegasPoints: newVegasTotal, totalOlympicPoints: newOlympicTotal, 
                    vegasMultiplier: last.multiplierUsed, scores: game.scores.slice(0,-1)
                });
                setUndoConfirm(false);
                setTimeout(() => {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }, 50);
            };

            let team1, team2;
            if (game.settings.vegasLogic === 'original') {
                team1 = manualTeamA;
                team2 = game.players.filter(p => !manualTeamA.includes(p.id)).map(p => p.id);
            } else {
                team1 = isThree ? [game.currentOrder[0], game.currentOrder[2]] : [game.currentOrder[0], game.currentOrder[3]];
                team2 = isThree ? [game.currentOrder[1]] : [game.currentOrder[1], game.currentOrder[2]];
            }

            return (
                <div className="pb-8">
                    {game.scores.length === 0 && (
                        <div className="mb-4">
                            <button onClick={() => setSetupConfirm(true)} className="w-full py-2.5 bg-gray-200 text-gray-600 rounded-xl font-bold text-xs flex items-center justify-center gap-1.5 active:bg-gray-300 transition btn-press"><i className="fa-solid fa-gear"></i> è¨­å®šã‚’ã‚„ã‚Šç›´ã™</button>
                        </div>
                    )}

                    <div className="bg-white rounded-2xl shadow-sm p-4 mb-4 text-center border border-gray-100">
                        <div className="flex items-center justify-between">
                            <h2 className="text-xl font-bold text-gray-800">Hole {game.currentHole}</h2>
                            <div className="flex bg-gray-100 rounded-lg p-1">
                                {[3, 4, 5].map(p => (
                                    <button key={p} onClick={() => setPar(p)} className={`px-4 py-1.5 rounded-md text-sm font-bold transition ${par === p ? 'bg-green-600 text-white shadow' : 'text-gray-400'}`}>Par {p}</button>
                                ))}
                            </div>
                        </div>
                    </div>

                    {game.settings.vegas && (
                        <div className="space-y-3">
                            {game.settings.vegasLogic === 'original' && (
                                <div className="bg-white p-3 rounded-xl border-2 border-dashed border-gray-200 mb-4 animate-fade-in">
                                    <label className="block text-[10px] font-bold text-blue-600 mb-2 uppercase text-center">ãƒãƒ¼ãƒ é¸æŠ (2åé¸æŠã§å…ˆè¡Œãƒãƒ¼ãƒ )</label>
                                    <div className="grid grid-cols-2 gap-2">
                                        {game.players.map(p => (
                                            <button 
                                                key={p.id}
                                                onClick={() => toggleManualTeam(p.id)}
                                                className={`py-2 rounded-lg text-xs font-bold transition flex items-center justify-center gap-2 border-2 ${manualTeamA.includes(p.id) ? 'bg-blue-50 border-blue-500 text-blue-700' : 'bg-white border-gray-100 text-gray-400'}`}
                                            >
                                                {manualTeamA.includes(p.id) ? <i className="fa-solid fa-check"></i> : null}
                                                {p.name}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            )}
                            <TeamCard color="blue" label="å…ˆè¡Œãƒãƒ¼ãƒ " pIds={team1} players={game.players} scores={scores} setScores={setScores} par={par} />
                            <div className="text-center font-bold text-gray-300 text-xs tracking-widest uppercase">vs</div>
                            <TeamCard color="red" label={isThree ? "2ä½ (Ã—2)" : "å¾Œæ”»ãƒãƒ¼ãƒ "} pIds={team2} players={game.players} scores={scores} setScores={setScores} par={par} />
                        </div>
                    )}

                    {game.settings.olympic && (
                        <div className="mt-6">
                            {game.settings.vegas && (
                                <button onClick={() => setShowOlympic(!showOlympic)} className="w-full py-3 bg-gray-200 rounded-xl font-bold flex items-center justify-center gap-2">
                                    <i className="fa-solid fa-medal"></i> ã‚ªãƒªãƒ³ãƒ”ãƒƒã‚¯å…¥åŠ› {showOlympic ? 'â–²' : 'â–¼'}
                                </button>
                            )}
                            {(showOlympic || !game.settings.vegas) && (
                                <div className="mt-2 bg-white rounded-xl shadow-sm p-3 border border-yellow-200 space-y-6 animate-fade-in">
                                    {game.players.map(p => {
                                        const opt = playerOptions[p.id];
                                        const pastFour = game.scores.filter(h => h.achievements?.[p.id]?.four).length;
                                        const pastStraight = game.scores.filter(h => h.achievements?.[p.id]?.straight).length;
                                        return (
                                            <div key={p.id} className="border-b border-gray-50 pb-3 last:border-0">
                                                <div className="flex items-center justify-between mb-2">
                                                    <div className="flex items-center gap-2">
                                                        <span className="text-sm font-bold text-gray-700 w-16 truncate">{p.name}</span>
                                                        {!game.settings.vegas && (
                                                            <input type="tel" inputMode="numeric" placeholder={par} value={scores[p.id]} onChange={(e) => setScores({...scores, [p.id]: e.target.value})} className="w-10 text-center text-lg font-black bg-gray-100 rounded focus:ring-0 outline-none p-1" />
                                                        )}
                                                    </div>
                                                    <div className="flex gap-1">
                                                        {['diamond', 'gold', 'silver', 'bronze', 'iron'].map(type => {
                                                            const isIron = type === 'iron';
                                                            const isDiamond = type === 'diamond';
                                                            const hasDiamondAnywhere = !!takenMedals['diamond'];
                                                            const hasIronAnywhere = !!takenMedals['iron'];
                                                            
                                                            let isDisabled = takenMedals[type] && takenMedals[type] !== p.id;
                                                            if (isIron && hasDiamondAnywhere) isDisabled = true;
                                                            if (isDiamond && hasIronAnywhere) isDisabled = true;
                                                            if (isIron && isThree) isDisabled = true;

                                                            return (
                                                                <MedalButton 
                                                                    key={type} 
                                                                    type={type} 
                                                                    current={olympicMedals[p.id]} 
                                                                    disabled={isDisabled} 
                                                                    onClick={() => setOlympicMedals(prev => prev[p.id] === type ? (()=>{const n={...prev}; delete n[p.id]; return n;})() : {...prev, [p.id]: type})} 
                                                                />
                                                            );
                                                        })}
                                                    </div>
                                                </div>
                                                <div className="opt-grid">
                                                    <button onClick={() => setPlayerOptions(v=>({...v,[p.id]:{...v[p.id],rodState:v[p.id].rodState===1?-1:v[p.id].rodState===-1?0:1}}))} className={`opt-btn ${opt.rodState===1?'active':opt.rodState===-1?'active-red':''}`}>
                                                        {opt.rodState === -1 ? 'ç«¿å¤±æ•—' : 'ç«¿ã‚¤ãƒ'}
                                                    </button>
                                                    <button onClick={() => setPlayerOptions(v=>({...v,[p.id]:{...v[p.id],sand:!v[p.id].sand}}))} className={`opt-btn ${opt.sand?'active':''}`}>ç ‚ã‚¤ãƒ</button>
                                                    <button onClick={() => setPlayerOptions(v=>({...v,[p.id]:{...v[p.id],near:!v[p.id].near}}))} className={`opt-btn ${opt.near?'active-gold':''}`} disabled={par!==3 && game.settings.vegas}>ãƒ‹ã‚¢ãƒ”ãƒ³</button>
                                                    <button onClick={() => setPlayerOptions(v=>({...v,[p.id]:{...v[p.id],reverse:!v[p.id].reverse}}))} className={`opt-btn ${opt.reverse?'active-red':''}`}>é€†ã‚ªãƒª</button>
                                                    <button className={`opt-btn ${playerOptions[p.id].birdie?'active':''}`} disabled>ãƒãƒ¼ãƒ‡ã‚£</button>
                                                    <button className={`opt-btn ${playerOptions[p.id].eagle?'active-gold':''}`} disabled>ã‚¤ãƒ¼ã‚°ãƒ«</button>
                                                    <button className={`opt-btn ${playerOptions[p.id].four || pastFour > 0 ? 'achieved' : 'placeholder'}`} disabled>4ã‚«ãƒ¼ãƒ‰{pastFour+(playerOptions[p.id].four?1:0)>1?` x${pastFour+(playerOptions[p.id].four?1:0)}`:''}</button>
                                                    <button className={`opt-btn ${playerOptions[p.id].straight || pastStraight > 0 ? 'achieved' : 'placeholder'}`} disabled>ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆ{pastStraight+(playerOptions[p.id].straight?1:0)>1?` x${pastStraight+(playerOptions[p.id].straight?1:0)}`:''}</button>
                                                </div>
                                                <div className="mt-2 flex items-center gap-2 justify-end">
                                                    <label className="text-[10px] font-bold text-gray-400">èª¿æ•´:</label>
                                                    <input type="text" value={playerOptions[p.id].manualAdj} onChange={(e) => setPlayerOptions(v=>({...v,[p.id]:{...v[p.id],manualAdj:e.target.value.replace(/[^-0-9]/g,'')}}))} className="w-12 text-center text-xs font-bold bg-gray-50 border rounded py-1 outline-none" />
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            )}
                        </div>
                    )}

                    <button onClick={handleCalculateAndSave} className="w-full mt-6 bg-green-600 text-white text-lg font-bold py-4 rounded-2xl shadow-lg btn-press">è¨ˆç®—ã—ã¦æ¬¡ã®ãƒ›ãƒ¼ãƒ«ã¸</button>

                    {game.scores.length > 0 && (
                        <button onClick={() => setUndoConfirm(true)} className="w-full mt-4 text-red-500 text-xs font-bold py-2 flex items-center justify-center gap-1"><i className="fa-solid fa-rotate-left"></i> å‰ã®ãƒ›ãƒ¼ãƒ«ã‚’ä¿®æ­£ã™ã‚‹</button>
                    )}

                    <HistorySection game={game} players={game.players} />

                    <button onClick={() => setShowFinal(true)} className="w-full mt-8 bg-white text-green-600 border-2 border-green-600 text-lg font-bold py-4 rounded-2xl btn-press shadow-sm">ç¾åœ¨ã¾ã§ã®çµæœã‚’è¦‹ã‚‹</button>

                    {setupConfirm && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-[120] animate-fade-in backdrop-blur-sm">
                            <div className="bg-white rounded-3xl w-full max-sm p-6 text-center shadow-2xl">
                                <div className="w-16 h-16 bg-blue-50 rounded-full flex items-center justify-center mx-auto mb-4"><i className="fa-solid fa-gear text-blue-500 text-3xl"></i></div>
                                <h3 className="text-gray-800 text-lg font-black mb-2">è¨­å®šã®ã‚„ã‚Šç›´ã—</h3>
                                <p className="text-gray-500 text-sm mb-6 leading-relaxed">è¨­å®šç”»é¢ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ<br/>ç¾åœ¨ã®ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã¯ç ´æ£„ã•ã‚Œã¾ã™ã€‚</p>
                                <div className="flex gap-3"><button onClick={() => setSetupConfirm(false)} className="flex-1 py-3.5 bg-gray-100 text-gray-500 rounded-xl font-bold btn-press">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button onClick={onRestartSetup} className="flex-1 py-3.5 bg-blue-600 text-white rounded-xl font-bold shadow-lg btn-press">ã‚„ã‚Šç›´ã™</button></div>
                            </div>
                        </div>
                    )}
                    {undoConfirm && (
                         <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-[110] animate-fade-in backdrop-blur-sm">
                            <div className="bg-white rounded-3xl w-full max-sm p-6 text-center shadow-2xl">
                                <div className="w-16 h-16 bg-red-50 rounded-full flex items-center justify-center mx-auto mb-4"><i className="fa-solid fa-triangle-exclamation text-red-500 text-3xl"></i></div>
                                <h3 className="text-gray-800 text-lg font-black mb-2">ä¿®æ­£</h3>
                                <p className="text-gray-500 text-sm mb-6">å–ã‚Šæ¶ˆã—ã¾ã™ã‹ï¼Ÿ</p>
                                <div className="flex gap-3"><button onClick={() => setUndoConfirm(false)} className="flex-1 py-3.5 bg-gray-100 text-gray-500 rounded-xl font-bold btn-press">æˆ»ã‚‹</button><button onClick={handleUndoLastHole} className="flex-1 py-3.5 bg-red-600 text-white rounded-xl font-bold shadow-lg btn-press">ä¿®æ­£ã™ã‚‹</button></div>
                            </div>
                        </div>
                    )}
                    {showFinal && <ResultsModal game={game} players={game.players} onClose={()=>setShowFinal(false)} onEnd={onBack} />}
                </div>
            );
        };

        const MedalButton = ({ type, current, onClick, disabled }) => {
            const icons = { diamond: 'ğŸ’', gold: 'ğŸ¥‡', silver: 'ğŸ¥ˆ', bronze: 'ğŸ¥‰', iron: 'ğŸ”©' };
            return <button onClick={onClick} disabled={disabled} className={`w-8 h-8 rounded-full flex items-center justify-center text-sm shadow-sm border transition medal-btn ${disabled ? 'disabled' : ''} ${current === type ? 'active bg-yellow-50 border-yellow-400' : 'bg-white border-gray-200'}`}>{icons[type]}</button>;
        };

        const TeamCard = ({ color, label, pIds, players, scores, setScores, par }) => (
            <div className={`rounded-2xl border-2 p-3 ${color === 'blue' ? 'bg-blue-50 border-blue-100' : 'bg-red-50 border-red-100'}`}>
                <div className={`text-[10px] font-black ${color === 'blue' ? 'text-blue-600' : 'text-red-600'} mb-2`}>{label}</div>
                <div className="flex gap-2">
                    {pIds.map(pid => (
                        <div key={pid} className="flex-1 bg-white/80 backdrop-blur rounded-xl p-2 shadow-sm text-center border border-white/50">
                            <div className="text-[10px] font-bold text-gray-600 truncate mb-1">{players.find(x => x.id === pid)?.name}</div>
                            <input type="tel" inputMode="numeric" pattern="[0-9]*" placeholder={par} value={scores[pid]} onChange={(e) => setScores({...scores, [pid]: e.target.value})} className="w-full text-center text-2xl font-black text-gray-800 bg-transparent rounded border-0 p-1 focus:ring-0 outline-none" />
                        </div>
                    ))}
                </div>
            </div>
        );

        const HistorySection = ({ game, players }) => {
            if (!game.scores || game.scores.length === 0) return null;
            const medalIcons = { diamond: 'ğŸ’', gold: 'ğŸ¥‡', silver: 'ğŸ¥ˆ', bronze: 'ğŸ¥‰', iron: 'ğŸ”©' };
            const isThree = game.players.length === 3;

            return (
                <div className="space-y-6 mt-8">
                    {game.settings.vegas && (
                        <div className="bg-white rounded-xl shadow-sm p-4 border border-gray-100 animate-fade-in">
                            <h3 className="text-[10px] font-bold text-blue-600 mb-2 uppercase border-l-4 border-blue-500 pl-2">Vegas History</h3>
                            <div className="max-h-40 overflow-y-auto no-scrollbar">
                                <table className="w-full text-center border-collapse text-[10px]">
                                    <thead className="sticky top-0 bg-white z-10"><tr className="text-gray-400 text-[10px]"><th className="p-2 bg-gray-50/95">H</th>{players.map(p => <th key={p.id} className="p-2 font-bold bg-gray-50/95">{p.name}</th>)}</tr></thead>
                                    <tbody>{game.scores.map((h, i) => (<tr key={i} className="border-b border-gray-50"><td className="p-2 text-gray-400 font-bold">{h.hole}</td>{players.map(p => { 
                                        let vP = 0;
                                        if (isThree) {
                                            if (h.teams.t1.includes(p.id)) vP = h.vegasDiff;
                                            else vP = -h.vegasDiff * 2;
                                        } else {
                                            vP = h.teams.t1.includes(p.id) ? h.vegasDiff : -h.vegasDiff;
                                        }
                                        return <td key={p.id} className="p-2"><div className={`font-black px-1.5 rounded-md py-1 ${vP > 0 ? 'text-blue-600 bg-blue-50' : vP < 0 ? 'text-red-500 bg-red-50' : 'text-gray-700 bg-gray-100'}`}>{vP > 0 ? '+' : ''}{vP}</div></td>;
                                    })}</tr>))}</tbody>
                                </table>
                            </div>
                        </div>
                    )}
                    {game.settings.olympic && (
                        <div className="bg-white rounded-xl shadow-sm p-4 border border-gray-100 animate-fade-in">
                            <h3 className="text-[10px] font-bold text-yellow-600 mb-2 uppercase border-l-4 border-blue-500 pl-2">Olympic History</h3>
                            <div className="max-h-40 overflow-y-auto no-scrollbar">
                                <table className="w-full text-center border-collapse text-[10px]">
                                    <thead className="sticky top-0 bg-white z-10"><tr className="text-gray-400 text-[10px]"><th className="p-2 bg-gray-50/95">H</th>{players.map(p => <th key={p.id} className="p-2 font-bold bg-gray-50/95">{p.name}</th>)}</tr></thead>
                                    <tbody>{game.scores.map((h, i) => (<tr key={i} className="border-b border-gray-50 last:border-0"><td className="p-2 text-gray-400 font-bold">{h.hole}</td>{players.map(p => { const oP = h.olympicPoints[p.id] || 0; return <td key={p.id} className="p-1"><div className={`font-black px-1 rounded-md py-1 flex items-center justify-center gap-0.5 ${oP > 0 ? 'text-blue-600 bg-blue-50' : oP < 0 ? 'text-red-500 bg-red-50' : 'text-gray-700 bg-gray-100'}`}>{h.medals?.[p.id] && <span>{medalIcons[h.medals[p.id]]}</span>}<span>{oP > 0 ? '+' : ''}{oP}</span></div></td>;})}</tr>))}</tbody>
                                </table>
                            </div>
                        </div>
                    )}
                    <div className="bg-white rounded-xl shadow-sm p-4 border border-gray-100 animate-fade-in">
                        <h3 className="text-[10px] font-bold text-green-600 mb-2 uppercase border-l-4 border-green-500 pl-2">Score History</h3>
                        <div className="max-h-60 overflow-y-auto no-scrollbar border border-gray-50 rounded-lg">
                            <table className="w-full text-center border-collapse">
                                <thead className="sticky top-0 bg-white z-10"><tr className="text-gray-400 text-[10px]"><th className="p-2 bg-gray-50/95">H(P)</th>{players.map(p => <th key={p.id} className="p-2 font-bold truncate max-w-[60px] bg-gray-50/95">{p.name}</th>)}</tr></thead>
                                <tbody>{game.scores.map((h, i) => (
                                    <tr key={i} className="border-b border-gray-50 last:border-0">
                                        <td className="p-2 font-bold text-gray-400 text-[10px]">{h.hole}({h.par})</td>
                                        {players.map(p => {
                                            const s = h.scores[p.id] === '' ? '-' : parseInt(h.scores[p.id]);
                                            const d = s === '-' ? null : s - h.par;
                                            return <td key={p.id} className="p-2"><div className={`text-[11px] font-black rounded-md py-1 ${d === null ? 'text-gray-400 bg-gray-50' : d < 0 ? 'text-blue-600 bg-blue-50' : d > 0 ? 'text-red-500 bg-red-50' : 'text-black bg-gray-100'}`}>{s}</div></td>;
                                        })}
                                    </tr>
                                ))}</tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        const ResultsModal = ({ game, players, onClose, onEnd }) => {
            const [showEndConfirm, setShowEndConfirm] = useState(false);
            const getPlayerScore = (pId) => {
                const outHoles = game.scores.filter(h => h.hole <= 9);
                const inHoles = game.scores.filter(h => h.hole > 9);
                const calc = (holes) => ({ strokes: holes.reduce((s, h) => s + (parseInt(h.scores[pId]) || 0), 0), pars: holes.reduce((s, h) => s + h.par, 0) });
                const o = calc(outHoles), i = calc(inHoles);
                return { out: o.strokes, in: i.strokes, total: o.strokes + i.strokes, diff: (o.strokes + i.strokes) - (o.pars + i.pars) };
            };
            return (
                <div className="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-[100] backdrop-blur-sm animate-fade-in">
                    <div className="bg-white rounded-3xl w-full max-sm p-6 text-center shadow-2xl relative overflow-hidden max-h-[90vh] flex flex-col">
                        <div className="absolute top-0 left-0 w-full h-2 bg-green-600"></div>
                        <h3 className="text-gray-800 text-xl font-black mb-4 mt-2 tracking-tighter">çµæœä¸€è¦§</h3>
                        <div className="flex-1 overflow-y-auto no-scrollbar space-y-4 mb-6">
                            {game.settings.vegas && (
                                <div className="p-4 rounded-2xl bg-blue-50 border border-blue-100"><h4 className="text-[10px] font-bold text-blue-600 mb-3 uppercase border-b border-blue-200 pb-1 text-left">Vegas Results</h4><div className="space-y-2">{players.map(p => { const v = game.totalVegasPoints[p.id]; return <div key={p.id} className="flex justify-between items-center text-sm font-bold"><span className="text-gray-600">{p.name}</span><span className={v >= 0 ? 'text-blue-600' : 'text-red-500'}>{v > 0 ? '+' : ''}{v}</span></div>;})}</div></div>
                            )}
                            {game.settings.olympic && (
                                <div className="p-4 rounded-2xl bg-yellow-50 border border-yellow-100"><h4 className="text-[10px] font-bold text-yellow-600 mb-3 uppercase border-b border-yellow-200 pb-1 text-left">Olympic Results (æˆå—ç‚¹)</h4><div className="space-y-2">{players.map(p => { const r = calcOlympicRelative(p.id, game.totalOlympicPoints); return <div key={p.id} className="flex justify-between items-center text-sm font-bold"><span className="text-gray-600">{p.name}</span><div className="flex items-center gap-2"><span className={r >= 0 ? 'text-blue-600' : 'text-red-500'}>{r > 0 ? '+' : ''}{r}</span><span className="text-[10px] text-gray-400 font-medium">({game.totalOlympicPoints[p.id] > 0 ? '+' : ''}{game.totalOlympicPoints[p.id]})</span></div></div>;})}</div></div>
                            )}
                            <div className="p-4 rounded-2xl bg-green-50 border border-green-100"><h4 className="text-[10px] font-bold text-green-600 mb-3 uppercase border-b border-green-200 pb-1 text-left">Stroke Score</h4><div className="space-y-2">{players.map(p => { const res = getPlayerScore(p.id); 
                                const diffColorClass = res.diff === 0 ? 'text-black' : (res.diff > 0 ? 'text-red-500' : 'text-blue-600');
                                return <div key={p.id} className="flex justify-between items-center text-sm font-bold"><span className="text-gray-600 w-16 truncate text-left">{p.name}</span><div className="flex-1 flex justify-end items-center gap-3"><span className="text-[10px] text-gray-700">O:{res.out}</span><span className="text-[10px] text-gray-700">I:{res.in}</span><span className="text-sm text-gray-800 font-black">T:{res.total}</span><span className={`min-w-[28px] text-right text-sm font-black ${diffColorClass}`}>{res.diff === 0 ? 'E' : (res.diff > 0 ? '+' + res.diff : res.diff)}</span></div></div>;
                            })}</div></div>
                        </div>
                        <div className="flex gap-3"><button onClick={() => setShowEndConfirm(true)} className="flex-1 py-4 bg-red-600 text-white rounded-2xl font-bold shadow-lg btn-press">çµ‚äº†ã™ã‚‹</button><button onClick={onClose} className="flex-1 py-4 bg-green-600 text-white rounded-2xl font-bold shadow-md btn-press">é–‰ã˜ã‚‹</button></div>
                    </div>
                    {showEndConfirm && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-[120] animate-fade-in backdrop-blur-sm">
                            <div className="bg-white rounded-3xl w-full max-sm p-6 text-center shadow-2xl"><h3 className="text-gray-800 text-lg font-black mb-2">çµ‚äº†ç¢ºèª</h3><p className="text-gray-500 text-sm mb-6 leading-relaxed">çµ‚äº†ã—ã¦æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ</p><div className="flex gap-3"><button onClick={() => setShowEndConfirm(false)} className="flex-1 py-3.5 bg-gray-100 text-gray-500 rounded-xl font-bold btn-press">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button onClick={onEnd} className="flex-1 py-3.5 bg-red-600 text-white rounded-xl font-bold shadow-lg btn-press">çµ‚äº†ã™ã‚‹</button></div></div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
