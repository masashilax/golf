<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- iOS Web App settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="V & O golf">
    <meta name="format-detection" content="telephone=no">

    <title>V & O golf</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            background-color: #f3f4f6; 
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            min-height: 100vh;
        }
        input, select, textarea { font-size: 16px !important; }
        input[type="number"]::-webkit-inner-spin-button, 
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .btn-press:active { transform: scale(0.96); opacity: 0.9; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .medal-btn { transition: all 0.2s; position: relative; }
        .medal-btn.active { transform: scale(1.1); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .medal-btn.disabled { opacity: 0.15; pointer-events: none; filter: grayscale(100%); }

        .opt-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(65px, 1fr)); 
            gap: 6px;
            margin-top: 8px;
        }
        
        .opt-btn { 
            font-size: 0.65rem; 
            padding: 6px 2px; 
            border-radius: 6px; 
            border: 1px solid #e5e7eb; 
            background: white; 
            color: #6b7280; 
            transition: all 0.2s;
            white-space: nowrap;
            text-align: center;
            font-weight: 500;
        }
        
        .opt-btn.active { background: #eff6ff; border-color: #3b82f6; color: #2563eb; font-weight: bold; }
        .opt-btn.active-red { background: #fef2f2; border-color: #ef4444; color: #dc2626; font-weight: bold; }
        .opt-btn.active-gold { background: #fefce8; border-color: #eab308; color: #a16207; font-weight: bold; }
        
        .opt-btn.achieved { 
            background: linear-gradient(135deg, #fef9c3 0%, #facc15 100%); 
            border-color: #eab308; 
            color: #713f12; 
            font-weight: 900; 
            box-shadow: 0 2px 4px rgba(234, 179, 8, 0.4);
            transform: scale(1.05);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0.4); }
            70% { box-shadow: 0 0 0 6px rgba(234, 179, 8, 0); }
            100% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0); }
        }

        .medal-btn.is-reverse.active {
            filter: hue-rotate(140deg) brightness(0.8);
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #d1d5db;
            transition: .4s;
            border-radius: 24px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 18px; width: 18px;
            left: 3px; bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: #16a34a; }
        input:checked + .slider:before { transform: translateX(20px); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const generateId = () => Math.random().toString(36).substr(2, 9);
        const getToday = () => new Date().toISOString().split('T')[0];

        const App = () => {
            const [view, setView] = useState('HOME');
            const [games, setGames] = useState([]);
            const [activeGameId, setActiveGameId] = useState(null);

            useEffect(() => {
                const saved = localStorage.getItem('golf_vegas_data');
                if (saved) setGames(JSON.parse(saved));
            }, []);

            useEffect(() => {
                localStorage.setItem('golf_vegas_data', JSON.stringify(games));
            }, [games]);

            const createGame = (setupData) => {
                const newGame = {
                    id: generateId(),
                    date: setupData.date,
                    course: setupData.course,
                    players: setupData.players,
                    scores: [],
                    currentHole: 1,
                    currentOrder: setupData.currentOrder || [0, 1, 2, 3],
                    totalVegasPoints: {0:0, 1:0, 2:0, 3:0},
                    totalOlympicPoints: {0:0, 1:0, 2:0, 3:0},
                    settings: setupData.settings,
                    isFinished: false
                };
                setGames([newGame, ...games]);
                setActiveGameId(newGame.id);
                setView('GAME');
            };

            const updateGame = (updatedGame) => {
                const newGames = games.map(g => g.id === updatedGame.id ? updatedGame : g);
                setGames(newGames);
            };

            const deleteGame = (e, id) => {
                e.stopPropagation();
                setView('HOME');
                setGames(games.filter(g => g.id !== id));
            };

            const activeGame = games.find(g => g.id === activeGameId);

            return (
                <div className="max-w-md mx-auto min-h-screen bg-gray-100 flex flex-col relative">
                    <div className="bg-green-700 text-white p-4 pt-4 shadow-lg sticky top-0 z-50 flex justify-between items-center border-b border-green-800">
                        <h1 className="text-lg font-bold flex items-center gap-2 truncate mr-2 italic">
                            <i className="fa-solid fa-golf-ball-tee"></i> V & O golf
                        </h1>
                        <div className="flex gap-2 items-center flex-shrink-0">
                            {view !== 'HOME' && (
                                <button onClick={() => setView('HOME')} className="text-xs bg-green-800 px-3 py-2 rounded-lg font-bold shadow-sm active:bg-green-900 text-white border border-green-600/50">
                                    ‰∏ÄË¶ß„Å∏
                                </button>
                            )}
                            <button onClick={() => window.location.reload()} className="text-xs bg-green-800 px-3 py-2 rounded-lg font-bold shadow-sm active:bg-green-900 text-white border border-green-600/50" title="ÂÜçË™≠„ÅøËæº„Åø">
                                <i className="fa-solid fa-rotate-right"></i>
                            </button>
                        </div>
                    </div>

                    <div className="flex-1 p-4 pb-24 safe-area-bottom">
                        {view === 'HOME' && (
                            <HomeScreen games={games} onNew={() => setView('NEW')} onSelect={(id) => { setActiveGameId(id); setView('GAME'); }} onDelete={deleteGame} />
                        )}
                        {view === 'NEW' && (
                            <NewGameScreen onCancel={() => setView('HOME')} onCreate={createGame} />
                        )}
                        {view === 'GAME' && activeGame && (
                            <GameScreen game={activeGame} onUpdate={updateGame} onBack={() => setView('HOME')} />
                        )}
                    </div>
                </div>
            );
        };

        const HomeScreen = ({ games, onNew, onSelect, onDelete }) => {
            return (
                <div className="space-y-6">
                    <div>
                        <h2 className="text-gray-500 text-xs font-bold mb-3 uppercase tracking-wider ml-1">Â±•Ê≠¥ ({games.length})</h2>
                        {games.length === 0 && <p className="text-center text-gray-400 py-12 bg-white rounded-xl border border-dashed border-gray-300">Â±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>}
                        <div className="space-y-3">
                            {games.map(game => (
                                <div key={game.id} onClick={() => onSelect(game.id)} className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 active:bg-gray-50 transition cursor-pointer relative overflow-hidden btn-press">
                                    <div className="absolute top-0 left-0 w-1.5 h-full bg-green-500"></div>
                                    <div className="flex justify-between items-start pl-3 mb-2">
                                        <div>
                                            <h3 className="font-bold text-gray-800 text-lg leading-tight">{game.course || '„Ç≥„Éº„ÇπÊú™Ë®≠ÂÆö'}</h3>
                                            <p className="text-gray-400 text-xs mt-1 font-medium"><i className="far fa-calendar-alt mr-1"></i>{game.date}</p>
                                        </div>
                                        <button onClick={(e) => {
                                            e.stopPropagation();
                                            // Â±•Ê≠¥ÂâäÈô§„Éú„Çø„É≥
                                            onDelete(e, game.id);
                                        }} className="text-gray-300 hover:text-red-500 p-2 -mr-2 -mt-2">
                                            <i className="fa-solid fa-trash"></i>
                                        </button>
                                    </div>
                                    <div className="pl-3 grid grid-cols-2 gap-x-4 gap-y-1">
                                        {game.players.map((p, i) => {
                                            const vP = game.totalVegasPoints ? game.totalVegasPoints[p.id] : 0;
                                            const oP = game.totalOlympicPoints ? game.totalOlympicPoints[p.id] : 0;
                                            return (
                                                <div key={i} className="text-[10px] text-gray-500 flex justify-between border-b border-gray-50 pb-0.5">
                                                    <span className="font-bold text-gray-700 truncate mr-1">{p.name}</span>
                                                    <span className="flex gap-1.5">
                                                        {game.settings?.vegas && (
                                                            <span>
                                                                V:<span className={vP >= 0 ? 'text-blue-600 font-bold' : 'text-red-500 font-bold'}>
                                                                    {vP > 0 ? '+' : ''}{vP}
                                                                </span>
                                                            </span>
                                                        )}
                                                        {game.settings?.olympic && (
                                                            <span>
                                                                O:<span className={oP >= 0 ? 'text-blue-600 font-bold' : 'text-red-500 font-bold'}>
                                                                    {oP > 0 ? '+' : ''}{oP}
                                                                </span>
                                                            </span>
                                                        )}
                                                    </span>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    <button 
                        onClick={onNew} 
                        className="fixed bottom-10 right-6 md:right-[calc(50%-180px)] w-16 h-16 bg-gradient-to-r from-green-600 to-green-500 hover:from-green-700 hover:to-green-600 text-white rounded-full shadow-2xl flex items-center justify-center text-3xl btn-press z-50 transition transform"
                        title="Êñ∞Ë¶è„Ç≤„Éº„É†"
                    >
                        <i className="fa-solid fa-plus"></i>
                    </button>
                </div>
            );
        };

        const NewGameScreen = ({ onCancel, onCreate }) => {
            const [course, setCourse] = useState('');
            const [date, setDate] = useState(getToday());
            const [playerData, setPlayerData] = useState([
                { name: 'ÊùæÊú¨Ê¥ã‰ªã', order: 1 },
                { name: '', order: 2 },
                { name: '', order: 3 },
                { name: '', order: 4 }
            ]);
            const [settings, setSettings] = useState({ vegas: true, olympic: true });

            const handleSubmit = () => {
                if (!course) { alert('„Ç¥„É´„ÉïÂ†¥Âêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
                if (!settings.vegas && !settings.olympic) { alert('„Ç≤„Éº„É†„É¢„Éº„Éâ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
                const players = playerData.map((p, i) => ({ id: i, name: p.name || `„Éó„É¨„Ç§„É§„Éº${i+1}` }));
                const currentOrder = [0, 1, 2, 3].sort((a, b) => playerData[a].order - playerData[b].order);
                onCreate({ date, course, players, settings, currentOrder });
            };

            const updatePlayer = (idx, field, val) => {
                const newData = [...playerData];
                newData[idx][field] = val;
                setPlayerData(newData);
            };

            const resetPlayers = () => setPlayerData([
                { name: 'ÊùæÊú¨Ê¥ã‰ªã', order: 1 },
                { name: '', order: 2 },
                { name: '', order: 3 },
                { name: '', order: 4 }
            ]);

            return (
                <div className="bg-white rounded-2xl shadow-sm p-5 space-y-6">
                    <h2 className="text-lg font-bold text-center border-b pb-3 text-gray-700">Êñ∞Ë¶è„Ç≤„Éº„É†Ë®≠ÂÆö</h2>
                    <div className="space-y-4">
                        <div>
                            <label className="block text-xs font-bold text-gray-500 mb-1 uppercase">Êó•‰ªò</label>
                            <input type="date" value={date} onChange={(e) => setDate(e.target.value)} className="w-full p-3 bg-gray-50 rounded-xl font-bold text-gray-800 outline-none focus:ring-2 ring-green-500 h-12" />
                        </div>
                        <div>
                            <label className="block text-xs font-bold text-gray-500 mb-1 uppercase">„Ç¥„É´„ÉïÂ†¥Âêç</label>
                            <input type="text" placeholder="‰æãÔºö„Äá„Äá„Ç´„É≥„Éà„É™„Éº" value={course} onChange={(e) => setCourse(e.target.value)} className="w-full p-3 bg-gray-50 rounded-xl font-bold text-gray-800 outline-none focus:ring-2 ring-green-500 placeholder-gray-300 h-12" />
                        </div>
                        
                        <div className="bg-gray-50 p-4 rounded-xl space-y-3 border border-gray-100">
                            <label className="block text-xs font-bold text-gray-500 mb-1 uppercase">„Ç≤„Éº„É†„É¢„Éº„Éâ</label>
                            <div className="flex justify-between items-center">
                                <span className="text-sm font-bold text-gray-700">„É©„Çπ„Éô„Ç¨„Çπ („ÉÅ„Éº„É†Êà¶)</span>
                                <label className="switch">
                                    <input type="checkbox" checked={settings.vegas} onChange={() => setSettings({...settings, vegas: !settings.vegas})} />
                                    <span className="slider"></span>
                                </label>
                            </div>
                            <div className="flex justify-between items-center">
                                <span className="text-sm font-bold text-gray-700">„Ç™„É™„É≥„Éî„ÉÉ„ÇØ („Éë„Çø„ÉºÊà¶)</span>
                                <label className="switch">
                                    <input type="checkbox" checked={settings.olympic} onChange={() => setSettings({...settings, olympic: !settings.olympic})} />
                                    <span className="slider"></span>
                                </label>
                            </div>
                        </div>

                        <div>
                            <div className="flex justify-between items-end mb-2">
                                <label className="block text-xs font-bold text-gray-500 uppercase ml-1">„É°„É≥„Éê„Éº„Å®ÂàùÊúüÊâìÈ†Ü</label>
                                <button onClick={resetPlayers} className="text-xs text-green-600 font-bold bg-green-50 px-2 py-1 rounded hover:bg-green-100 transition"><i className="fa-solid fa-rotate-left mr-1"></i>„ÇØ„É™„Ç¢</button>
                            </div>
                            <div className="space-y-4">
                                {playerData.map((p, i) => (
                                    <div key={i} className="flex items-end gap-2">
                                        <div className="flex-1">
                                            <input 
                                                type="text" 
                                                value={p.name} 
                                                onChange={(e) => updatePlayer(i, 'name', e.target.value)} 
                                                placeholder="ÂêçÂâç„ÇíÂÖ•Âäõ" 
                                                className="w-full p-2.5 bg-gray-50 rounded-lg text-sm text-gray-800 font-medium outline-none focus:ring-2 ring-green-500 h-11" 
                                            />
                                        </div>
                                        <div className="w-20">
                                            <select 
                                                value={p.order}
                                                onChange={(e) => updatePlayer(i, 'order', parseInt(e.target.value))}
                                                className="w-full p-2.5 bg-gray-100 rounded-lg text-xs font-bold text-gray-600 outline-none border-0 h-11"
                                            >
                                                {[1, 2, 3, 4].map(n => <option key={n} value={n}>{n}Áï™ÁõÆ</option>)}
                                            </select>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                    <div className="flex gap-3 pt-2">
                        <button onClick={onCancel} className="flex-1 py-3 bg-gray-100 text-gray-600 rounded-xl font-bold btn-press">„Ç≠„É£„É≥„Çª„É´</button>
                        <button onClick={handleSubmit} className="flex-1 py-3 bg-green-600 text-white rounded-xl font-bold shadow-md btn-press">ÈñãÂßã</button>
                    </div>
                </div>
            );
        };

        const GameScreen = ({ game, onUpdate, onBack }) => {
            const [par, setPar] = useState(4);
            const [scores, setScores] = useState({0:'', 1:'', 2:'', 3:''});
            const [showFinal, setShowFinal] = useState(false);
            const [showOlympic, setShowOlympic] = useState(game.settings.olympic);
            const [olympicMedals, setOlympicMedals] = useState({}); 
            const [undoConfirm, setUndoConfirm] = useState(false); 
            
            const initialOpts = {
                rod: false, sand: false, near: false, reverse: false, 
                birdie: false, eagle: false, four: false, straight: false,
                rodState: 0, isIronFail: false, manualAdj: ''
            };
            const [playerOptions, setPlayerOptions] = useState({
                0: { ...initialOpts }, 1: { ...initialOpts }, 2: { ...initialOpts }, 3: { ...initialOpts }
            });

            const MEDAL_PTS = { diamond: 5, gold: 4, silver: 3, bronze: 2, iron: 1 };
            const MEDAL_REVERSE_PTS = { diamond: -5, gold: -1, silver: -2, bronze: -3, iron: -4 };

            const getPlayerMedalStats = (pId, currentMedal) => {
                let counts = { diamond: 0, gold: 0, silver: 0, bronze: 0, iron: 0 };
                game.scores.forEach(h => { if (h.medals && h.medals[pId]) counts[h.medals[pId]]++; });
                if (currentMedal) counts[currentMedal]++;
                return counts;
            };

            const calcStraightSets = (counts) => {
                let sets = 0, c = { ...counts };
                while (true) {
                    let needed = ['gold', 'silver', 'bronze', 'iron'], missing = 0;
                    needed.forEach(m => { if (!c[m] || c[m] <= 0) missing++; });
                    if (missing === 0) { needed.forEach(m => c[m]--); sets++; }
                    else if (c['diamond'] >= missing) { needed.forEach(m => { if (c[m] > 0) c[m]--; }); c['diamond'] -= missing; sets++; }
                    else break;
                }
                return sets;
            };

            useEffect(() => {
                if (!game.settings.olympic) return;
                setPlayerOptions(prev => {
                    const next = { ...prev };
                    game.players.forEach(p => {
                        const currentMedal = olympicMedals[p.id];
                        const counts = getPlayerMedalStats(p.id, currentMedal);
                        const prevCounts = getPlayerMedalStats(p.id, null); 
                        let isFourCard = false;
                        ['diamond', 'gold', 'silver', 'bronze', 'iron'].forEach(type => {
                            if (counts[type] > 0 && counts[type] % 4 === 0 && counts[type] !== prevCounts[type]) isFourCard = true;
                        });
                        const isStraight = calcStraightSets(counts) > calcStraightSets(prevCounts);
                        const sc = parseInt(scores[p.id]);
                        next[p.id] = { ...next[p.id], four: isFourCard, straight: isStraight, birdie: (sc === par - 1), eagle: (sc <= par - 2) };
                    });
                    return next;
                });
            }, [olympicMedals, scores, par]);

            const players = game.players;
            const currentOrder = game.currentOrder;
            const team1 = [currentOrder[0], currentOrder[3]];
            const team2 = [currentOrder[1], currentOrder[2]];

            const takenMedals = useMemo(() => {
                return Object.entries(olympicMedals).reduce((acc, [id, type]) => { acc[type] = id; return acc; }, {});
            }, [olympicMedals]);

            const handleMedalClick = (pId, type) => {
                setOlympicMedals(prev => {
                    if (prev[pId] === type) { const next = { ...prev }; delete next[pId]; return next; }
                    if (Object.values(prev).includes(type)) return prev;
                    return { ...prev, [pId]: type };
                });
            };

            const toggleOption = (pId, key) => {
                if (['four', 'straight', 'birdie', 'eagle'].includes(key)) return; 
                setPlayerOptions(prev => ({ ...prev, [pId]: { ...prev[pId], [key]: !prev[pId][key] } }));
            };

            const handleManualAdjChange = (pId, value) => {
                // „Éû„Ç§„Éä„Çπ„ÄÅÊï∞ÂÄ§„ÅÆ„Åø„ÇíË®±ÂèØ„Åô„ÇãÊ≠£Ë¶èË°®Áèæ„Éê„É™„Éá„Éº„Ç∑„Éß„É≥
                if (value === '' || value === '-' || /^-?\d*$/.test(value)) {
                    setPlayerOptions(prev => ({ ...prev, [pId]: { ...prev[pId], manualAdj: value } }));
                }
            };

            const toggleRod = (pId) => {
                setPlayerOptions(prev => {
                    const current = prev[pId].rodState;
                    let next = (current === 0) ? 1 : (current === 1) ? -1 : 0;
                    return { ...prev, [pId]: { ...prev[pId], rodState: next } };
                });
            };

            const handleCalculateAndSave = () => {
                for(let i=0; i<4; i++) { if(scores[i] === '') { alert('ÂÖ®Âì°„ÅÆ„Çπ„Ç≥„Ç¢„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; } }
                const s = (pid) => parseInt(scores[pid]);
                let vegasDiff = 0, olympicPoints = {0:0, 1:0, 2:0, 3:0};
                if (game.settings.vegas) {
                    const t1S = team1.map(pid => s(pid)), t2S = team2.map(pid => s(pid));
                    let p1 = Math.min(...t1S) * 10 + Math.max(...t1S), p2 = Math.min(...t2S) * 10 + Math.max(...t2S);
                    const checkV = (scs) => {
                        const hasE = scs.some(sc => sc <= par - 2), bCount = scs.filter(sc => sc <= par - 1).length;
                        return { rank: (hasE || bCount === 2) ? 2 : (bCount > 0 ? 1 : 0), hasE };
                    };
                    const res1 = checkV(t1S), res2 = checkV(t2S);
                    let mult = 1;
                    if (res1.rank > 0) { if (res1.rank === 2) mult *= 2; p2 = Math.max(...t2S) * 10 + Math.min(...t2S); }
                    if (res2.rank > 0) { if (res2.rank === 2) mult *= 2; p1 = Math.min(...t1S) * 10 + Math.min(...t1S); }
                    const raw = (p2 - p1) * mult;
                    vegasDiff = (raw >= 0 ? Math.ceil(Math.abs(raw) / 5) * 5 : -Math.ceil(Math.abs(raw) / 5) * 5);
                }
                if (game.settings.olympic) {
                    const hasDiamond = !!takenMedals['diamond'];
                    players.forEach(p => {
                        const opt = playerOptions[p.id];
                        let pts = 0;
                        if (opt.eagle) pts += 15; else if (opt.birdie) pts += 3;
                        if (opt.isSand) pts += 3; if (opt.rodState === 1) pts += 3; else if (opt.rodState === -1) pts -= 3;
                        if (opt.isIronFail) pts -= 1;
                        const medal = olympicMedals[p.id];
                        if (medal) {
                            let mPt = opt.reverse ? MEDAL_REVERSE_PTS[medal] : MEDAL_PTS[medal];
                            if (medal === 'iron' && hasDiamond) mPt = 0;
                            pts += mPt;
                        }
                        if (opt.four) {
                            const cnts = getPlayerMedalStats(p.id, medal);
                            ['diamond', 'gold', 'silver', 'bronze', 'iron'].forEach(t => { if (cnts[t] > 0 && cnts[t] % 4 === 0) pts += (MEDAL_PTS[t] * 4); });
                        }
                        if (opt.straight) { pts += (getPlayerMedalStats(p.id, medal)['diamond'] > 0 ? 15 : 10); }
                        if (par === 3 && opt.near) {
                            let valid = !opt.reverse && !players.some(o => o.id !== p.id && s(o.id) <= s(p.id));
                            if (valid) pts += 3;
                        }
                        pts += (parseInt(opt.manualAdj) || 0);
                        olympicPoints[p.id] = pts;
                    });
                }
                const newVegasTotal = { ...game.totalVegasPoints }, newOlympicTotal = { ...game.totalOlympicPoints };
                players.forEach(p => {
                    if (game.settings.vegas) newVegasTotal[p.id] += (team1.includes(p.id) ? vegasDiff : -vegasDiff);
                    if (game.settings.olympic) newOlympicTotal[p.id] += olympicPoints[p.id];
                });
                const newOrder = [...currentOrder].sort((a, b) => (s(a) - s(b)) || (currentOrder.indexOf(a) - currentOrder.indexOf(b)));
                const newHistory = [...game.scores, { hole: game.currentHole, par, vegasDiff, olympicPoints, scores: { ...scores }, teams: { t1: team1, t2: team2 }, medals: { ...olympicMedals }, orderBefore: [...currentOrder] }];
                onUpdate({ ...game, currentHole: game.currentHole + 1, currentOrder: newOrder, totalVegasPoints: newVegasTotal, totalOlympicPoints: newOlympicTotal, scores: newHistory });
                setScores({0:'', 1:'', 2:'', 3:''}); setOlympicMedals({});
                setPlayerOptions({ 0: { ...initialOpts }, 1: { ...initialOpts }, 2: { ...initialOpts }, 3: { ...initialOpts } });
                setShowOlympic(game.settings.olympic); setPar(4);
            };

            const handleUndoLastHole = () => {
                if (game.scores.length === 0) return;
                const newHistory = [...game.scores];
                const lastHole = newHistory.pop(); 
                const newVegasTotal = { ...game.totalVegasPoints };
                const newOlympicTotal = { ...game.totalOlympicPoints };
                players.forEach(p => {
                    if (game.settings.vegas) {
                        const wasT1 = lastHole.teams.t1.includes(p.id);
                        newVegasTotal[p.id] -= (wasT1 ? lastHole.vegasDiff : -lastHole.vegasDiff);
                    }
                    if (game.settings.olympic) {
                        newOlympicTotal[p.id] -= (lastHole.olympicPoints[p.id] || 0);
                    }
                });
                onUpdate({ ...game, currentHole: game.currentHole - 1, currentOrder: lastHole.orderBefore, totalVegasPoints: newVegasTotal, totalOlympicPoints: newOlympicTotal, scores: newHistory });
                setUndoConfirm(false);
                window.scrollTo(0, 0);
            };

            return (
                <div className="pb-8">
                    <div className="bg-white rounded-2xl shadow-sm p-4 mb-4 text-center border border-gray-100">
                        <div className="flex justify-between items-center mb-3">
                            <h2 className="text-xl font-bold text-gray-800">Hole {game.currentHole}</h2>
                            <div className="flex bg-gray-100 rounded-lg p-1">
                                {[3, 4, 5].map(p => (
                                    <button key={p} onClick={() => setPar(p)} className={`px-4 py-1.5 rounded-md text-sm font-bold transition ${par === p ? 'bg-green-600 text-white shadow' : 'text-gray-400'}`}>Par {p}</button>
                                ))}
                            </div>
                        </div>
                    </div>

                    {game.settings.vegas ? (
                        <div className="space-y-3">
                            <TeamCard color="blue" label="„ÉÅ„Éº„É† A" pIds={team1} players={players} scores={scores} setScores={setScores} par={par} />
                            <div className="text-center font-bold text-gray-300 text-sm tracking-widest uppercase">vs</div>
                            <TeamCard color="red" label="„ÉÅ„Éº„É† B" pIds={team2} players={players} scores={scores} setScores={setScores} par={par} />
                        </div>
                    ) : (
                        <div className="grid grid-cols-2 gap-3">
                            {players.map(p => (
                                <div key={p.id} className="bg-white p-3 rounded-xl border border-gray-100 shadow-sm text-center">
                                    <div className="text-[10px] font-bold text-gray-500 mb-1">{p.name}</div>
                                    <input type="tel" inputMode="numeric" placeholder={par} value={scores[p.id]} onChange={(e) => setScores({...scores, [p.id]: e.target.value})} className="w-full text-center text-2xl font-black text-gray-800 bg-gray-50 rounded p-1 outline-none" />
                                </div>
                            ))}
                        </div>
                    )}

                    {game.settings.olympic && (
                        <div className="mt-6">
                            <button onClick={() => setShowOlympic(!showOlympic)} className={`w-full py-3 rounded-xl font-bold flex items-center justify-center gap-2 transition ${showOlympic ? 'bg-yellow-100 text-yellow-800 shadow-inner' : 'bg-gray-200 text-gray-600'}`}>
                                <i className="fa-solid fa-medal"></i> „Ç™„É™„É≥„Éî„ÉÉ„ÇØÂÖ•Âäõ {showOlympic ? '‚ñ≤' : '‚ñº'}
                            </button>
                            {showOlympic && (
                                <div className="mt-2 bg-white rounded-xl shadow-sm p-3 border border-yellow-200 animate-fade-in space-y-6">
                                    {players.map(p => {
                                        const medal = olympicMedals[p.id], opt = playerOptions[p.id];
                                        const isIronDisabled = !!takenMedals['diamond'] && medal !== 'iron'; 
                                        const getOther = (type) => (takenMedals[type] !== undefined && takenMedals[type] !== String(p.id)) ? takenMedals[type] : null;
                                        return (
                                            <div key={p.id} className="border-b border-gray-100 pb-3 last:border-0">
                                                <div className="flex items-center justify-between mb-2">
                                                    <div className="text-sm font-bold text-gray-700 w-16 truncate">{p.name}</div>
                                                    <div className="flex gap-1 flex-1 justify-end">
                                                        {['diamond', 'gold', 'silver', 'bronze', 'iron'].map(type => (
                                                            <MedalButton key={type} type={type} label={type === 'diamond' ? 'üíé' : type === 'gold' ? 'ü•á' : type === 'silver' ? 'ü•à' : type === 'bronze' ? 'ü•â' : 'üî©'} current={medal} isReverse={opt.reverse} disabled={type === 'iron' ? (isIronDisabled || !!getOther('iron')) : !!getOther(type)} onClick={() => handleMedalClick(p.id, type)} />
                                                        ))}
                                                    </div>
                                                </div>
                                                <div className="opt-grid">
                                                    <button onClick={() => toggleRod(p.id)} className={`opt-btn ${opt.rodState === 1 ? 'active' : opt.rodState === -1 ? 'active-red' : ''}`}>{opt.rodState === 1 ? 'Á´øÊàêÂäü' : opt.rodState === -1 ? 'Á´øÂ§±Êïó' : 'Á´ø„Ç§„ÉÅ'}</button>
                                                    <button onClick={() => toggleOption(p.id, 'sand')} className={`opt-btn ${opt.sand ? 'active' : ''}`}>Á†Ç„Ç§„ÉÅ</button>
                                                    <button onClick={() => toggleOption(p.id, 'near')} className={`opt-btn ${opt.near ? 'active-gold' : ''}`} disabled={par !== 3}>„Éã„Ç¢„Éî„É≥</button>
                                                    <button onClick={() => toggleOption(p.id, 'reverse')} className={`opt-btn ${opt.reverse ? 'active-red' : ''}`}>ÈÄÜ„Ç™„É™</button>
                                                    <button className={`opt-btn ${opt.birdie ? 'active' : ''}`} disabled>„Éê„Éº„Éá„Ç£</button>
                                                    <button className={`opt-btn ${opt.eagle ? 'active-gold' : ''}`} disabled>„Ç§„Éº„Ç∞„É´</button>
                                                    <button className={`opt-btn ${opt.four ? 'achieved' : ''}`} disabled>4„Ç´„Éº„Éâ</button>
                                                    <button className={`opt-btn ${opt.straight ? 'achieved' : ''}`} disabled>„Çπ„Éà„É¨„Éº„Éà</button>
                                                </div>
                                                <div className="mt-2 flex items-center gap-2 justify-end">
                                                    <label className="text-[10px] font-bold text-gray-400">„É≠„Éº„Ç´„É´„É´„Éº„É´:</label>
                                                    <input 
                                                        type="text" 
                                                        inputMode="text" 
                                                        placeholder="¬±0" 
                                                        value={opt.manualAdj} 
                                                        onChange={(e) => handleManualAdjChange(p.id, e.target.value)} 
                                                        className="w-16 text-center text-xs font-bold text-gray-700 bg-gray-50 border border-gray-200 rounded py-1 outline-none focus:ring-1 focus:ring-yellow-500" 
                                                    />
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            )}
                        </div>
                    )}

                    <button onClick={handleCalculateAndSave} className="w-full mt-6 bg-gradient-to-r from-green-600 to-green-500 hover:from-green-700 hover:to-green-600 text-white text-lg font-bold py-4 rounded-2xl shadow-lg btn-press tracking-wider">
                        Ë®àÁÆó„Åó„Å¶Ê¨°„ÅÆ„Éõ„Éº„É´„Å∏
                    </button>

                    {game.scores.length > 0 && (
                        <button onClick={() => setUndoConfirm(true)} className="w-full mt-4 bg-red-50 text-red-600 text-[11px] font-bold py-3 rounded-xl border border-red-200 btn-press flex items-center justify-center gap-1.5 shadow-sm">
                            <i className="fa-solid fa-rotate-left"></i> 1„Å§Ââç„ÅÆ„Éõ„Éº„É´„Çí‰øÆÊ≠£„Åô„Çã
                        </button>
                    )}

                    <HistorySection game={game} players={players} />

                    <button onClick={() => setShowFinal(true)} className="w-full mt-8 bg-gradient-to-r from-green-600 to-green-500 hover:from-green-700 hover:to-green-600 text-white text-lg font-bold py-4 rounded-2xl shadow-lg btn-press tracking-wider">
                        „Ç≤„Éº„É†„ÇíÁµÇ‰∫Ü„Åó„Å¶ÁµêÊûú„ÇíË¶ã„Çã
                    </button>

                    {undoConfirm && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-[100] animate-fade-in backdrop-blur-sm">
                            <div className="bg-white rounded-3xl w-full max-w-sm p-6 text-center shadow-2xl">
                                <div className="w-16 h-16 bg-red-50 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <i className="fa-solid fa-triangle-exclamation text-red-500 text-3xl"></i>
                                </div>
                                <h3 className="text-gray-800 text-lg font-black mb-2">„Éõ„Éº„É´„ÅÆ„ÇÑ„ÇäÁõ¥„Åó</h3>
                                <p className="text-gray-500 text-sm mb-6 leading-relaxed">1„Å§Ââç„ÅÆ„Éõ„Éº„É´„ÅÆË®àÁÆóÁµêÊûú„ÇíÂèñ„ÇäÊ∂à„Åó„Å¶„ÄÅÂÖ•Âäõ„Çí„ÇÑ„ÇäÁõ¥„Åó„Åæ„Åô„ÅãÔºü</p>
                                <div className="flex gap-3">
                                    <button onClick={() => setUndoConfirm(false)} className="flex-1 py-3.5 bg-gray-100 text-gray-500 rounded-xl font-bold btn-press">„Ç≠„É£„É≥„Çª„É´</button>
                                    <button onClick={handleUndoLastHole} className="flex-1 py-3.5 bg-red-600 text-white rounded-xl font-bold shadow-lg btn-press">ÂÆüË°å„Åô„Çã</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showFinal && (
                         <div className="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-[100] animate-fade-in backdrop-blur-sm">
                            <div className="bg-white rounded-3xl w-full max-w-sm p-6 text-center shadow-2xl relative overflow-hidden">
                                <div className="absolute top-0 left-0 w-full h-2 bg-green-600"></div>
                                <h3 className="text-gray-800 text-xl font-black mb-6 mt-4 tracking-tighter">Êú¨Êó•„ÅÆÊúÄÁµÇÁµêÊûúÁô∫Ë°®</h3>
                                <div className="space-y-4 mb-8 max-h-[60vh] overflow-y-auto no-scrollbar">
                                    {game.settings.vegas && (
                                        <div className="p-4 rounded-2xl bg-blue-50 border border-blue-100">
                                            <h4 className="text-[10px] font-bold text-blue-600 mb-3 uppercase border-b border-blue-200 pb-1">Vegas Results</h4>
                                            <div className="space-y-2">
                                                {players.map(p => (
                                                    <div key={p.id} className="flex justify-between items-center text-sm font-bold">
                                                        <span className="text-gray-600">{p.name}</span>
                                                        <span className={game.totalVegasPoints[p.id] >= 0 ? 'text-blue-600' : 'text-red-500'}>{game.totalVegasPoints[p.id] > 0 ? '+' : ''}{game.totalVegasPoints[p.id]}</span>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                    {game.settings.olympic && (
                                        <div className="p-4 rounded-2xl bg-yellow-50 border border-yellow-100">
                                            <h4 className="text-[10px] font-bold text-yellow-600 mb-3 uppercase border-b border-yellow-200 pb-1">Olympic Results</h4>
                                            <div className="space-y-2">
                                                {players.map(p => (
                                                    <div key={p.id} className="flex justify-between items-center text-sm font-bold">
                                                        <span className="text-gray-600">{p.name}</span>
                                                        <span className={game.totalOlympicPoints[p.id] >= 0 ? 'text-blue-600' : 'text-red-500'}>{game.totalOlympicPoints[p.id] > 0 ? '+' : ''}{game.totalOlympicPoints[p.id]}</span>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </div>
                                <div className="flex gap-3 px-4 pb-4">
                                    <button onClick={() => setShowFinal(false)} className="flex-1 py-4 bg-gray-100 text-gray-500 rounded-2xl font-bold btn-press">Èñâ„Åò„Çã</button>
                                    <button onClick={() => onBack()} className="flex-1 py-4 bg-green-600 text-white rounded-2xl font-bold shadow-lg btn-press">‰∏ÄË¶ß„Å∏Êàª„Çã</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const MedalButton = ({ type, label, current, onClick, disabled, isReverse }) => {
            const isActive = current === type;
            const baseClass = `w-8 h-8 rounded-full flex items-center justify-center text-sm shadow-sm border transition medal-btn relative ${disabled ? 'disabled' : ''} ${isActive && isReverse ? 'is-reverse' : ''}`;
            let colorClass = isActive ? (
                type === 'diamond' ? "bg-blue-100 border-blue-400 text-blue-600 ring-2 ring-blue-200" :
                type === 'gold' ? "bg-yellow-100 border-yellow-400 text-yellow-700 ring-2 ring-yellow-200" :
                type === 'silver' ? "bg-gray-100 border-gray-400 text-gray-600 ring-2 ring-gray-200" :
                type === 'bronze' ? "bg-orange-100 border-orange-400 text-orange-800 ring-2 ring-orange-200" :
                "bg-slate-200 border-slate-500 text-slate-800 ring-2 ring-slate-200"
            ) : "bg-white border-gray-200 text-gray-400";
            return <button onClick={onClick} disabled={disabled} className={`${baseClass} ${colorClass}`}>{label}</button>;
        };

        const HistorySection = ({ game, players }) => {
            if (!game.scores || game.scores.length === 0) return null;
            return (
                <div className="space-y-6 mt-6">
                    {game.settings.vegas && (
                        <div className="bg-white rounded-xl shadow-sm p-4 border border-gray-100">
                            <h3 className="text-[10px] font-bold text-blue-600 mb-2 uppercase border-l-4 border-blue-500 pl-2">Vegas History</h3>
                            <div className="max-h-60 overflow-y-auto no-scrollbar border border-gray-50 rounded-lg">
                                <table className="w-full text-center border-collapse min-w-[300px]">
                                    <thead className="sticky top-0 bg-white z-10"><tr className="text-gray-500"><th className="p-2 text-[10px] bg-gray-50/95">H</th>{players.map(p => <th key={p.id} className="p-2 font-bold truncate max-w-[60px] text-[10px] bg-gray-50/95">{p.name}</th>)}</tr></thead>
                                    <tbody>{game.scores.map((h, i) => (
                                        <tr key={i} className="border-b border-gray-50 last:border-0"><td className="p-2 font-bold text-gray-400 text-[10px]">{h.hole}</td>{players.map(p => {
                                            const vP = h.teams.t1.includes(p.id) ? h.vegasDiff : -h.vegasDiff;
                                            return <td key={p.id} className="p-2"><div className={`text-[10px] font-black px-1.5 rounded-md py-1 ${vP >= 0 ? 'text-blue-600 bg-blue-50' : 'text-red-500 bg-red-50'}`}>{vP > 0 ? '+' : ''}{vP}</div></td>;
                                        })}</tr>
                                    ))}</tbody>
                                </table>
                            </div>
                        </div>
                    )}
                    {game.settings.olympic && (
                        <div className="bg-white rounded-xl shadow-sm p-4 border border-gray-100">
                            <h3 className="text-[10px] font-bold text-yellow-600 mb-2 uppercase border-l-4 border-yellow-500 pl-2">Olympic History</h3>
                            <div className="max-h-60 overflow-y-auto no-scrollbar border border-gray-50 rounded-lg">
                                <table className="w-full text-center border-collapse min-w-[300px]">
                                    <thead className="sticky top-0 bg-white z-10"><tr className="text-gray-500"><th className="p-2 text-[10px] bg-gray-50/95">H</th>{players.map(p => <th key={p.id} className="p-2 font-bold truncate max-w-[60px] text-[10px] bg-gray-50/95">{p.name}</th>)}</tr></thead>
                                    <tbody>{game.scores.map((h, i) => (
                                        <tr key={i} className="border-b border-gray-50 last:border-0"><td className="p-2 font-bold text-gray-400 text-[10px]">{h.hole}</td>{players.map(p => {
                                            const oP = h.olympicPoints[p.id] || 0;
                                            return <td key={p.id} className="p-2"><div className={`text-[10px] font-black px-1.5 rounded-md py-1 ${oP >= 0 ? 'text-blue-600 bg-blue-50' : 'text-red-500 bg-red-50'}`}>{oP > 0 ? '+' : ''}{oP}</div></td>;
                                        })}</tr>
                                    ))}</tbody>
                                </table>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const TeamCard = ({ color, label, pIds, players, scores, setScores, par }) => {
            const isBlue = color === 'blue';
            return (
                <div className={`rounded-2xl border-2 p-3 ${isBlue ? 'bg-blue-50 border-blue-100' : 'bg-red-50 border-red-100'}`}>
                    <div className={`text-[10px] font-black ${isBlue ? 'text-blue-600' : 'text-red-600'} mb-2 flex justify-between tracking-widest uppercase`}>{label}</div>
                    <div className="flex gap-2.5">
                        {pIds.map((pid) => {
                            const p = players.find(x => x.id === pid);
                            return (
                                <div key={pid} className="flex-1 bg-white/80 backdrop-blur rounded-xl p-2 shadow-sm text-center border border-white/50">
                                    <div className="text-[10px] font-bold text-gray-600 truncate mb-1">{p.name}</div>
                                    <input type="tel" inputMode="numeric" pattern="[0-9]*" placeholder={par} value={scores[pid]} onChange={(e) => setScores({...scores, [pid]: e.target.value})} className="w-full text-center text-2xl font-black text-gray-800 bg-transparent rounded border-0 p-1 focus:ring-0 outline-none" />
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
